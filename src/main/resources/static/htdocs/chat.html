<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Simple Chat</title>
</head>
<style>
    body {
        display: flex; /* Flexbox ë ˆì´ì•„ì›ƒìœ¼ë¡œ ì±„íŒ… ì˜ì—­ê³¼ ìœ ì € ë¦¬ìŠ¤íŠ¸ ë‚˜ë€íˆ ë°°ì¹˜ */
        flex-direction: row; /* ì±„íŒ…ì°½ê³¼ ìœ ì €ë¦¬ìŠ¤íŠ¸ë¥¼ ê°€ë¡œë¡œ ë‚˜ì—´ */
        margin: 0;
        padding: 10px; /* ì „ì²´ì ì¸ ì—¬ë°± */
        height: calc(100vh - 20px); /* ë·°í¬íŠ¸ ë†’ì´ì—ì„œ íŒ¨ë”© ì œì™¸ */
        box-sizing: border-box; /* íŒ¨ë”©ì„ ë„ˆë¹„/ë†’ì´ì— í¬í•¨ */
    }

    /* ê¸°ì¡´ ìš”ì†Œë“¤ (p#output, a)ì€ ì±„íŒ…ì°½ ì˜ì—­ ë°–ìœ¼ë¡œ ëºë‹ˆë‹¤ */
    #top-info-area {
        position: absolute; /* ì ˆëŒ€ ìœ„ì¹˜ë¡œ ê¸°ì¡´ ì •ë³´ í‘œì‹œ ì˜ì—­ ë¶„ë¦¬ */
        flex-direction: column; /* ì„¸ë¡œë¡œ ë‚˜ì—´ */
        top: 10px;
        left: 10px;
        z-index: 10;
        display: flex; /* ìì‹ ìš”ì†Œë“¤ì„ ì •ë ¬í•˜ê¸° ìœ„í•´ flex ì‚¬ìš© */
        align-items: flex-start; /* ì™¼ìª½ ì •ë ¬ */
    }

    #chat-main-container {
        display: flex; /* ì±„íŒ… ì»¨í…Œì´ë„ˆì™€ ìœ ì € ë¦¬ìŠ¤íŠ¸ë¥¼ ë‚˜ë€íˆ */
        flex-grow: 1; /* ë‚¨ì€ ê³µê°„ì„ ì±„ì›€ */
        height: 100%; /* ë¶€ëª¨(body)ì˜ ë†’ì´ì— ë§ì¶¤ */
        width: 100%;
    }

    #chat-con{
        margin-top: 100px;
        border: 1px solid #ccc;
        width: 100%;
        height: auto;
        overflow: hidden;
        display: flex;
        margin-right: 10px; /* ìœ ì € ë¦¬ìŠ¤íŠ¸ì™€ì˜ ê°„ê²© */
        flex-direction: column-reverse;
    }
    #chat-log{
        padding: 10px 10px 0 10px;
        margin-bottom: 5px;
        list-style: none;
        overflow-y: auto;
        scroll-behavior: smooth;
        order: 2; /* flex-direction: column; ì¼ ë•Œ ì•„ë˜ìª½ì— ë°°ì¹˜ */
    }
    li {
        margin-bottom: 2px;
        padding: 5px;
        border: 1px solid #eee;
        font: 14px Consolas bold;
    }

    #input-area {
        display: flex; /* ì…ë ¥ì°½ê³¼ ë²„íŠ¼ì„ ê°€ë¡œë¡œ ë‚˜ë€íˆ */
        padding: 5px 10px;
        border-top: 1px solid #eee;
        align-items: center; /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
        order: 1; /* flex-direction: column; ì¼ ë•Œ ë§¨ ì•„ë˜ìª½ì— ë°°ì¹˜ */
        flex-shrink: 0; /* í¬ê¸°ê°€ ì¤„ì–´ë“¤ì§€ ì•Šë„ë¡ ê³ ì • */
        background-color: white; /* ë°°ê²½ìƒ‰ìœ¼ë¡œ ìŠ¤í¬ë¡¤ë°” ìœ„ë¡œ ì˜¬ë¼ì˜¤ì§€ ì•Šë„ë¡ ë°©ì§€ */
        position: relative; /* ë¯¸ë¦¬ë³´ê¸° ìœ„ì¹˜ì˜ ê¸°ì¤€ì  */
    }

    #box {
        flex-grow: 1;
        margin-top: 5px;
        margin-right: 5px;
        height: 20px;
        width: auto;
        font: 16px Consolas bold;
    }

    #namebox{
        margin-top: 5px;
        margin-right: 5px;
        height: 20px;
        width: 80px;
        font: 16px Consolas bold;
    }

    #button {
        margin-top: 5px;
        height: 25px;
        width: 60px;
    }

    /* --- ìœ ì € ë¦¬ìŠ¤íŠ¸ ì¶”ê°€ ìŠ¤íƒ€ì¼ --- */
    #user-list-area {
        margin-top: 100px;
        width: 150px; /* ìœ ì € ë¦¬ìŠ¤íŠ¸ ë„ˆë¹„ ê³ ì • */
        border: 1px solid #ccc;
        display: flex;
        flex-direction: column;
        flex-shrink: 0; /* ìœ ì € ë¦¬ìŠ¤íŠ¸ í¬ê¸°ê°€ ì¤„ì–´ë“¤ì§€ ì•Šë„ë¡ ê³ ì • */
    }
    #user-list-area h3 {
        margin: 0;
        padding: 10px;
        background-color: #f0f0f0;
        border-bottom: 1px solid #ccc;
        font-size: 16px;
    }
    #user-list {
        list-style: none;
        padding: 10px;
        margin: 0;
        overflow-y: auto; /* ìœ ì € ëª©ë¡ì— ìŠ¤í¬ë¡¤ë°” ë¶€ì—¬ */
        flex-grow: 1; /* ë‚¨ì€ ê³µê°„ì„ ì±„ìš°ë„ë¡ */
    }
    #user-list li {
        padding: 5px;
        border: none; /* ìœ ì € ë¦¬ìŠ¤íŠ¸ liëŠ” í…Œë‘ë¦¬ ì—†ìŒ */
        margin-bottom: 0;
        cursor: default; /* í´ë¦­ ê°€ëŠ¥í•œ ìš”ì†Œ ì•„ë‹ˆë¯€ë¡œ */
        background-color: transparent;
        font: 14px Consolas bold; /* ì±„íŒ… ë¡œê·¸ liì™€ ë™ì¼ í°íŠ¸ */
    }
    #user-list li:hover {
        background-color: #f0f0f0; /* ë§ˆìš°ìŠ¤ ì˜¬ë ¸ì„ ë•Œ ë°°ê²½ìƒ‰ */
        cursor: pointer;          /* ë§ˆìš°ìŠ¤ ì»¤ì„œë¥¼ ì†ê°€ë½ ëª¨ì–‘ìœ¼ë¡œ */
    }

    /* --- User Profile Popover Styles --- */
    .profile-popover {
        display: none; /* í‰ì†Œì—ëŠ” ìˆ¨ê¹€ */
        position: absolute; /* ë‹¤ë¥¸ ìš”ì†Œ ìœ„ì— ë–  ìˆë„ë¡ */
        width: 250px;
        background-color: white;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        z-index: 100;
        font-family: sans-serif;
        font-size: 14px;
    }
    .profile-popover-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background-color: #f7f7f7;
        border-bottom: 1px solid #eee;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
    }
    .profile-popover-header .nickname {
        font-weight: bold;
        font-size: 16px;
    }
    .profile-popover-header .close-btn {
        font-size: 20px;
        color: #aaa;
        cursor: pointer;
    }
    .profile-popover-header .close-btn:hover {
        color: #000;
    }
    .profile-popover-body {
        padding: 12px;
    }
    .popover-top-section {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    .popover-profile-pic {
        width: 50px; /* ì¡°ê¸ˆ ì‘ê²Œ ì¡°ì • */
        height: 50px;
        border-radius: 50%;
        margin-right: 12px;
        flex-shrink: 0;
    }
    .popover-user-info p {
        margin: 0;
    }
    .popover-bottom-section .status-message {
        margin-top: 0; /* ìœ„ìª½ ì—¬ë°± ì œê±° */
    }
    .profile-popover-body .status-message {
        margin-top: 4px;
        padding: 8px;
        background-color: #f9f9f9;
        border-radius: 4px;
        min-height: 20px;
        white-space: pre-wrap; /* ì¤„ë°”ê¿ˆê³¼ ê³µë°± ìœ ì§€ */
        overflow-wrap: break-word; /* ê¸´ í…ìŠ¤íŠ¸ ê°•ì œ ì¤„ë°”ê¿ˆ */
    }

    /* --- ì±„íŒ… ë©”ì‹œì§€ í”„ë¡œí•„ ì‚¬ì§„ ìŠ¤íƒ€ì¼ --- */
    .chat-message-item {
        display: flex;
        align-items: flex-start; /* ìƒë‹¨ ì •ë ¬ */
        margin-bottom: 10px;
    }
    .chat-profile-img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 10px;
        flex-shrink: 0; /* ì´ë¯¸ì§€ í¬ê¸° ê³ ì • */
    }
    .chat-message-content {
        display: flex;
        flex-direction: column;
    }
    .chat-message-header {
        margin-bottom: 4px;
    }
    .chat-author-name {
        font-weight: bold;
        margin-right: 8px;
    }
    .chat-timestamp {
        font-size: 0.8em;
        color: #888;
    }
    .chat-message-body {
        line-height: 1.4;
    }

    /* --- ë§í¬ ë¯¸ë¦¬ë³´ê¸° ì¹´ë“œ ìŠ¤íƒ€ì¼ --- */
    .link-preview-card {
        border: 1px solid #e1e8ed;
        border-radius: 8px;
        margin-top: 8px;
        overflow: hidden; /* ë‚´ë¶€ ìš”ì†Œê°€ ì¹´ë“œë¥¼ ë²—ì–´ë‚˜ì§€ ì•Šë„ë¡ */
        max-width: 400px; /* ì¹´ë“œì˜ ìµœëŒ€ ë„ˆë¹„ */
        text-decoration: none; /* a íƒœê·¸ì˜ ë°‘ì¤„ ì œê±° */
        color: inherit; /* ë¶€ëª¨ ìš”ì†Œì˜ ê¸€ììƒ‰ ìƒì† */
        display: block; /* a íƒœê·¸ë¥¼ ë¸”ë¡ ìš”ì†Œë¡œ ë§Œë“¤ì–´ ì „ì²´ ì˜ì—­ í´ë¦­ ê°€ëŠ¥í•˜ê²Œ */
    }
    .link-preview-card:hover {
        background-color: #f5f8fa;
    }
    .link-preview-image {
        width: 100%;
        height: 210px; /* ì´ë¯¸ì§€ ë†’ì´ ê³ ì • */
        object-fit: cover; /* ì´ë¯¸ì§€ê°€ ì˜ì—­ì— ê½‰ ì°¨ë„ë¡ */
        border-bottom: 1px solid #e1e8ed;
    }
    .link-preview-info {
        padding: 12px;
    }
    .link-preview-title {
        font-weight: bold;
        font-size: 15px;
        margin-bottom: 4px;
        /* ì—¬ëŸ¬ ì¤„ ë§ì¤„ì„ ì²˜ë¦¬ (ì„ íƒ ì‚¬í•­) */
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .link-preview-description {
        font-size: 14px;
        color: #657786;
        /* ì—¬ëŸ¬ ì¤„ ë§ì¤„ì„ ì²˜ë¦¬ */
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .link-preview-url {
        font-size: 12px;
        color: #8899a6;
        margin-top: 8px;
    }

    /* --- íŒŒì¼ ì²¨ë¶€ ë¯¸ë¦¬ë³´ê¸° ìŠ¤íƒ€ì¼ --- */
    #file-preview-container {
        display: none; /* í‰ì†Œì—ëŠ” ìˆ¨ê¹€ */
        position: absolute;
        bottom: 100%; /* #input-area ë°”ë¡œ ìœ„ì— ìœ„ì¹˜ */
        left: 0;
        width: 100%;
        max-height: 250px; /* ë¯¸ë¦¬ë³´ê¸° ì „ì²´ ìµœëŒ€ ë†’ì´ */
        overflow-y: auto; /* ë‚´ìš©ì´ ë§ìœ¼ë©´ ìŠ¤í¬ë¡¤ */
        background-color: #f8f9fa;
        border-top: 1px solid #dee2e6;
        padding: 8px 10px;
        box-sizing: border-box;
    }
    #file-preview-image-area {
        display: flex; /* ê°€ë¡œ ì •ë ¬ */
        flex-wrap: wrap; /* ì¤„ ë°”ê¿ˆ */
        gap: 8px; /* ì´ë¯¸ì§€ ê°„ê²© */
        margin-bottom: 8px;
    }
    #file-preview-image-area:empty {
        display: none; /* ë‚´ìš© ì—†ìœ¼ë©´ ìˆ¨ê¹€ */
    }
    .preview-image-wrapper {
        position: relative;
    }
    .preview-image-wrapper img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 4px;
        border: 1px solid #ddd;
    }
    #file-preview-list-area {
        display: flex;
        flex-direction: column;
        gap: 4px;
        margin-bottom: 8px;
    }
    #file-preview-list-area:empty {
        display: none; /* ë‚´ìš© ì—†ìœ¼ë©´ ìˆ¨ê¹€ */
    }
    .file-preview-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
        color: #495057;
    }
    #file-preview-bottom-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-top: 1px solid #eee;
        padding-top: 8px;
    }
    #file-preview-bottom-bar:has(:not(:empty)) {
        border-top: 1px solid #eee;
        padding-top: 8px;
    }
    #file-preview-info {
        font-size: 13px;
        color: #6c757d;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        flex-grow: 1;
        margin-right: 10px;
    }
    #file-preview-actions {
        flex-shrink: 0;
    }
    #file-preview-actions button {
        margin-left: 5px;
    }
    .remove-file-btn {
        background-color: rgba(0,0,0,0.6);
        color: white;
        border: 1px solid white;
        border-radius: 50%;
        text-align: center;
        cursor: pointer;
        font-family: sans-serif;
        font-weight: bold;
    }
    .preview-image-wrapper .remove-file-btn {
        position: absolute;
        top: -5px;
        right: -5px;
        width: 18px;
        height: 18px;
        line-height: 16px;
        font-size: 14px;
    }
    .file-preview-item .remove-file-btn {
        background: none;
        border: none;
        color: #6c757d;
        font-size: 20px;
        font-weight: bold;
        line-height: 1;
        margin-left: 8px;
        padding: 0 5px;
    }
    .remove-file-btn:hover {
        background-color: rgba(255, 0, 0, 0.8);
        color: white;
    }
    .file-preview-item .remove-file-btn:hover {
        background: none;
        color: red;
    }

</style>
</html>
<body>


<div id="chat-main-container">
    <div id="top-info-area">
        <a href="index.html" style="margin-bottom: 5px;">ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸°</a>
        <div style="display: flex; align-items: center;">
            <p id="output" style="margin-right: 15px;">ì—¬ê¸°ì— ì‘ë‹µ í‘œì‹œ</p>
            <div style="float:right">
            <button id="exit-button" style="margin-left: 10px;">ë‚˜ê°€ê¸°</button>
            <button id="delete-room-button" style="margin-left: 10px; background-color: #dc3545; color: white; display: none;">ë°© ì‚­ì œ</button>
            </div>
        </div>
    </div>

    <div id="chat-con">
        <ul id="chat-log">
            <li id="top-of-chat" style="height: 500px; background-color: transparent; margin: 0; padding: 0; border: none;"></li>
        </ul>

        <div id="input-area">
            <div id="file-preview-container">
                <div id="file-preview-image-area"></div>
                <div id="file-preview-list-area"></div>
                <div id="file-preview-bottom-bar">
                    <div id="file-preview-info"></div>
                    <div id="file-preview-actions">
                        <button id="file-cancel-btn">ì·¨ì†Œ</button>
                        <button id="file-confirm-upload-btn">ì „ì†¡</button>
                    </div>
                </div>
            </div>

            <input type="text" id="namebox" name="namebox">
            <input type="text" id="box" name="box" placeholder="ë©”ì‹œì§€ ì…ë ¥">
            
            <!-- íŒŒì¼ ì—…ë¡œë“œ ë²„íŠ¼ ì¶”ê°€ -->
            <input type="file" id="file-input" style="display: none;" multiple>
            <label for="file-input" id="file-upload-btn" style="cursor: pointer; font-size: 20px; margin: 0 10px;">ğŸ“</label>

            <button id="button" onclick="send()">ë³´ë‚´ê¸°</button>
        </div>
    </div>

    <div id="user-list-area">
        <h3>ë©¤ë²„ ëª©ë¡ (<span id="user-count">0</span>)</h3>
        <ul id="user-list">
        </ul>
    </div>
</div>

<!-- ================================================== -->
<!-- =========== ë°© ì‚­ì œ ì•Œë¦¼ ëª¨ë‹¬ UI ì‹œì‘ ============ -->
<!-- ================================================== -->
<div id="room-deleted-modal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); justify-content: center; align-items: center;">
    <div style="background-color: #fff; margin: auto; padding: 20px 30px 30px; border: 1px solid #888; width: 80%; max-width: 400px; border-radius: 8px; box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19); text-align: center;">
        <h2 style="color: #d9534f;">ë°©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤</h2>
        <p>ê´€ë¦¬ìì— ì˜í•´ í˜„ì¬ ì±„íŒ…ë°©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë¡œë¹„ë¡œ ëŒì•„ê°€ì£¼ì„¸ìš”.</p>
        <button id="go-to-lobby-btn" style="padding: 10px 20px; font-size: 16px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 20px;">ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>
</div>
<!-- ================================================== -->
<!-- =========== ë°© ì‚­ì œ ì•Œë¦¼ ëª¨ë‹¬ UI ë ============ -->
<!-- ================================================== -->

<!-- ================================================== -->
<!-- =========== í”„ë¡œí•„ ëª¨ë‹¬ UI ì‹œì‘ ============ -->
<!-- ================================================== -->
<div id="profile-modal" style="display: none; position: fixed; z-index: 1500; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center;">
    <div id="profile-modal-content" style="background-color: #fff; margin: auto; padding: 20px 30px 30px; border: 1px solid #888; width: 80%; max-width: 450px; border-radius: 8px; box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19); text-align: left; position: relative;">
        <span id="profile-modal-close" style="position: absolute; top: 10px; right: 20px; color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
        <h2 id="profile-nickname" style="text-align: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px;">ë‹‰ë„¤ì„</h2>
        <div>
            <p style="font-weight: bold; margin-bottom: 5px;">ìƒíƒœ ë©”ì‹œì§€:</p>
            <div id="profile-status-view" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; min-height: 50px; background-color: #f9f9f9;">
                <p id="profile-status-text" style="margin: 0;"></p>
            </div>
            <textarea id="profile-status-edit" style="display: none; width: calc(100% - 22px); min-height: 50px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; resize: vertical;"></textarea>
        </div>
        <div id="profile-buttons" style="text-align: right; margin-top: 20px;">
            <button id="profile-edit-btn" style="display: none; padding: 8px 15px; background-color: #5cb85c; color: white; border: none; border-radius: 5px; cursor: pointer;">ìˆ˜ì •</button>
            <button id="profile-save-btn" style="display: none; padding: 8px 15px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">ì €ì¥</button>
            <button id="profile-cancel-btn" style="display: none; padding: 8px 15px; background-color: #f0ad4e; color: white; border: none; border-radius: 5px; cursor: pointer; margin-left: 5px;">ì·¨ì†Œ</button>
        </div>
    </div>
</div>
<!-- ================================================== -->
<!-- =========== í”„ë¡œí•„ ëª¨ë‹¬ UI ë ============ -->
<!-- ================================================== -->

<!-- User Profile Popover -->
<div id="user-profile-popover" class="profile-popover">
    <div class="profile-popover-header">
        <span id="popover-nickname" class="nickname"></span>
        <span id="popover-close" class="close-btn">&times;</span>
    </div>
    <div class="profile-popover-body">
        <div class="popover-top-section">
            <img id="popover-profile-img" src="" alt="Profile" class="popover-profile-pic">
            <div class="popover-user-info">
                <p><strong> <span id="popover-userid"></span></strong></p>
                <p><span id="popover-username"></span></p>
            </div>
        </div>
        <div class="popover-bottom-section">
            <p id="popover-status" class="status-message"></p>
        </div>
    </div>
</div>

</body>
<script LANGUAGE="javascript" src="/sockjs.min.js"></script>
<script LANGUAGE="javascript" src="/stomp.js"></script>
<script>
	let SERVER_BASE_URL = "10.50.131.25:8080";
    SERVER_BASE_URL = "http://localhost:8080";

	// ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘ ë¶€ë¶„ì— ë³€ìˆ˜ ì„ ì–¸ ì¶”ê°€
    let isLoading = true;
	let stompClient = null;
	let username, id, nickname, role;
    let observer, firstMessageId = null, chatCount = 0, linesToLoad;
    let users = [];     // ì±„íŒ…ë°© ìœ ì €ë“¤

	const urlParams = new URLSearchParams(window.location.search);
	let roomId = urlParams.get('room'); // 'room' ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ê°’ ê°€ì ¸ì˜¤ê¸°

	// ... ê¸°ì¡´ p, chatLogElement, box, button ë³€ìˆ˜ë“¤ ...
	const messageInput = document.getElementById('box'); // ê¸°ì¡´ id "box" ì‚¬ìš©
	const sendButton = document.getElementById('button'); // ê¸°ì¡´ id "button" ì‚¬ìš©
	const chatLogElement = document.getElementById('chat-log'); // ê¸°ì¡´ id "chat-log" ì‚¬ìš©
	const nameboxInput = document.getElementById('namebox');
	const userListElement = document.getElementById('user-list'); // ìƒˆë¡œ ì¶”ê°€: ìœ ì € ë¦¬ìŠ¤íŠ¸ UL ìš”ì†Œ
	const userCountElement = document.getElementById('user-count'); // ìƒˆë¡œ ì¶”ê°€: ìœ ì € ìˆ˜ í‘œì‹œ SPAN ìš”ì†Œ
    const topElement = document.getElementById("top-of-chat");
    const profilePopover = document.getElementById('user-profile-popover');

	// --- WebSocket/STOMP ê´€ë ¨ í•¨ìˆ˜ ì¶”ê°€ ì‹œì‘ ---

	// ì›¹ì†Œì¼“ ì—°ê²° ì‹œì‘ (í˜ì´ì§€ ë¡œë“œ ë˜ëŠ” íŠ¹ì • ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œ)
	function connect() {
        // ì´ ì˜ˆì œì—ì„œëŠ” ì‚¬ìš©ì ì´ë¦„ì„ "client"ë¡œ ê³ ì •í–ˆì§€ë§Œ, ì‹¤ì œë¡œëŠ” ì…ë ¥ë°›ì•„ ì‚¬ìš©
        // username = document.getElementById('usernameInput').value.trim(); // ì‚¬ìš©ì ì…ë ¥ ì‹œ í™œì„±í™”

		console.log("WebSocket ì—°ê²° ì‹œë„...");
		var socket = new SockJS(SERVER_BASE_URL+'/ws');
		stompClient = Stomp.over(socket);

		stompClient.heartbeat.outgoing = 0;   // ë‚´ê°€ ë³´ë‚´ëŠ” í•˜íŠ¸ë¹„íŠ¸(ms)
		stompClient.heartbeat.incoming = 0;   // ì„œë²„ì—ì„œ ê¸°ëŒ€í•˜ëŠ” í•˜íŠ¸ë¹„íŠ¸(ms)

        // STOMP í´ë¼ì´ì–¸íŠ¸ ì—°ê²°
        // ì—°ê²° ì„±ê³µ ì‹œ onConnected í˜¸ì¶œ, ì‹¤íŒ¨ ì‹œ onError í˜¸ì¶œ
		stompClient.connect({'user_id': id, 'room_id': roomId }, onConnected, onError);

		// STOMP í´ë¼ì´ì–¸íŠ¸ ê°ì²´ê°€ stompClient ë¼ê³  ê°€ì •í•©ë‹ˆë‹¤.
		stompClient.ws.onclose = function(event) {
			console.error('WebSocket Closed. Code:', event.code, 'Reason:', event.reason);
			// ì—¬ê¸°ì— ê¸°ì¡´ì˜ ì—°ê²° ì‹¤íŒ¨ ì²˜ë¦¬ ë¡œì§ (stompClient.debug, reconnet ë“±)ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
			// ì˜ˆë¥¼ ë“¤ì–´:
			stompClient.debug("Whoops! Lost connection to " + this.url);
			// ... (ê¸°ì¡´ ì—ëŸ¬ ì²˜ë¦¬ ë¡œì§)
		};
	}

	// ì—°ê²° ëŠê¸° (í•„ìš” ì‹œ)
	function disconnect() {
		if (stompClient !== null) {
			stompClient.disconnect();
		}
		console.log("Disconnected");
	}

	// STOMP ì—°ê²° ì„±ê³µ ì‹œ í˜¸ì¶œë˜ëŠ” ì½œë°± í•¨ìˆ˜
	function onConnected() {
		console.log("WebSocket ì—°ê²° ì„±ê³µ!");
		//document.getElementById("output").textContent = "ì„œë²„ ì‘ë‹µ: WebSocket ì—°ê²°ë¨"; // ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸

        // ìœ ì €ì •ë³´ ë°›ì•„ì˜¤ëŠ” ì±„ë„
        stompClient.subscribe('/topic/'+roomId+'/users', onUserInfoReceived);
        // ì±„íŒ… í† í”½ êµ¬ë…: ì„œë²„ê°€ /topic/publicìœ¼ë¡œ ë³´ë‚´ëŠ” ëª¨ë“  ìƒˆ ë©”ì‹œì§€ë¥¼ ìˆ˜ì‹ 
		stompClient.subscribe('/topic/'+roomId+'/public', onMessageReceived);
        // ë©”ì‹œì§€ ë¦¬ìŠ¤íŠ¸ë¥¼ í•œë²ˆì— ë¶ˆëŸ¬ì˜¤ëŠ” í† í”½
        stompClient.subscribe('/user/topic/queue/reply', onMessageListReceived);
        // ë§í¬ ë¯¸ë¦¬ë³´ê¸° ì •ë³´ë¥¼ ë°›ì•„ì˜¤ëŠ” í† í”½
        stompClient.subscribe('/topic/' + roomId + '/previews', onPreviewReceived);

        // (ì„ íƒ ì‚¬í•­) ì„œë²„ì— ì‚¬ìš©ì ë“±ë¡ ë©”ì‹œì§€ ì „ì†¡ (ì„¸ì…˜ì— ì‚¬ìš©ì ì´ë¦„ ì €ì¥ìš©)
        // ë°±ì—”ë“œ ChatStompControllerì˜ @MessageMapping("/chat.addUser")ë¥¼ ì‚¬ìš©í•œë‹¤ë©´
        // stompClient.send("/app/chat.addUser", {}, JSON.stringify({ sender: username }));

	}

	// STOMP ì—°ê²° ì‹¤íŒ¨ ì‹œ í˜¸ì¶œë˜ëŠ” ì½œë°± í•¨ìˆ˜
	function onError(error) {
		console.error("WebSocket ì—°ê²° ì‹¤íŒ¨:", error);
		document.getElementById("output").textContent = "ì„œë²„ ì‘ë‹µ: WebSocket ì—°ê²° ì‹¤íŒ¨. " + error;
	}

    function onMessageListReceived(payload){
        const msgList = JSON.parse(payload.body).msgList;
        console.log("ì›¹ì†Œì¼“ìœ¼ë¡œ ìƒˆ ë©”ì‹œì§€ë¦¬ìŠ¤íŠ¸ ìˆ˜ì‹ :", msgList);

        if( msgList.length > 0 ) {
            const previousScrollHeight = chatLogElement.scrollHeight;
            const previousScrollTop = chatLogElement.scrollTop;

            msgList.forEach(msg => {
                displayMessage(msg, 0); // ë°›ì€ ë©”ì‹œì§€ë¥¼ í™”ë©´ì— í‘œì‹œ
            });

            const newScrollHeight = chatLogElement.scrollHeight;
            chatLogElement.scrollTop = previousScrollTop + (newScrollHeight - previousScrollHeight);

            if (observer) observer.observe(topElement);
        } else {
            console.log("ë” ì´ìƒ ë¶ˆëŸ¬ì˜¬ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.");
            topElement.remove();
            if (observer) observer.disconnect();
        }

        isLoading = false;
    }

    function onPreviewReceived(payload) {
        const preview = JSON.parse(payload.body);
        console.log("ì›¹ì†Œì¼“ìœ¼ë¡œ ë§í¬ ë¯¸ë¦¬ë³´ê¸° ìˆ˜ì‹ :", preview);

        const previewContainer = document.getElementById(`preview-for-${preview.messageId}`);
        if (!previewContainer) return; // í•´ë‹¹ ë©”ì‹œì§€ê°€ í™”ë©´ì— ì—†ìœ¼ë©´ ë¬´ì‹œ

        const displayUrl = preview.url.length > 50 ? preview.url.slice(0, 47) + '...' : preview.url;

        const cardHtml = `
            <a href="${preview.url}" target="_blank" class="link-preview-card">
                ${preview.imageUrl ? `<img src="${preview.imageUrl}" class="link-preview-image" alt="Preview" onerror="this.style.display='none';">` : ''}
                <div class="link-preview-info">
                    <div class="link-preview-title">${escapeHtml(preview.title || '')}</div>
                    <div class="link-preview-description">${escapeHtml(preview.description || '')}</div>
                    <div class="link-preview-url">${escapeHtml(displayUrl)}</div>
                </div>
            </a>
        `;

        previewContainer.innerHTML = cardHtml;
        chatLogElement.scrollTop = chatLogElement.scrollHeight; // ìŠ¤í¬ë¡¤ì„ ì•„ë˜ë¡œ ë‚´ë ¤ì„œ ë³´ì—¬ì¤Œ
    }

	// ì›¹ì†Œì¼“ì„ í†µí•´ ìƒˆ ë©”ì‹œì§€ë¥¼ ë°›ì•˜ì„ ë•Œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
	function onMessageReceived(payload) {
		const message = JSON.parse(payload.body);
		console.log("ì›¹ì†Œì¼“ìœ¼ë¡œ ìƒˆ ë©”ì‹œì§€ ìˆ˜ì‹ :", message);

		displayMessage(message, 1); // ë°›ì€ ë©”ì‹œì§€ë¥¼ í™”ë©´ì— í‘œì‹œ
	}

	// ì›¹ì†Œì¼“ì„ í†µí•´ ìƒˆ ìœ ì €ì •ë³´ë¥¼ ë°›ì•˜ì„ ë•Œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
	function onUserInfoReceived(payload) {
		const userDto = JSON.parse(payload.body);
        const userIndex = users.findIndex(user => user.id === userDto.userId );

        switch (userDto.eventType) {
            case "ENTER":
                if (userIndex === -1) {
                    // ë¦¬ìŠ¤íŠ¸ì— ì—†ìœ¼ë©´ ìƒˆë¡œ ì¶”ê°€
                    users.push({
                        id: userDto.userId,
                        name: userDto.nickname,
                        role: userDto.role,
                        conn: "CONNECT"
                    });
                } else {
                    // ì´ë¯¸ ìˆìœ¼ë©´ ì ‘ì† ìƒíƒœë§Œ ë³€ê²½
                    users[userIndex].conn = "CONNECT";
                }
                break; // case ì¢…ë£Œë¥¼ ìŠì§€ ë§ˆì„¸ìš”!

            case "EXIT": // ë˜ëŠ” "DISCONNECT"
                if (userIndex !== -1)
                    users[userIndex].conn = "DISCONNECT";
                break;

            case "NICK_CHANGE":
                if (userIndex !== -1) {
                    users[userIndex].name = userDto.nickname;
                    if( userDto.userId === id )
                        nickname = userDto.nickname;
                }
                break;

            case "ROOM_OUT": // ëª…ì‹œì  í‡´ì¥
                if (userDto.userId === id) {    // ë‚´ê°€ ë‚˜ê°„ ê²½ìš°
                    alert("ë°©ì—ì„œ í‡´ì¥í–ˆìŠµë‹ˆë‹¤. ë¡œë¹„ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
                    window.location.href = 'index.html';
                    return; // í˜ì´ì§€ ì´ë™ì´ ì˜ˆì •ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ë” ì´ìƒ UI ì—…ë°ì´íŠ¸ ë¶ˆí•„ìš”
                }

                if (userIndex !== -1) {         // ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ë‚˜ê°„ ê²½ìš°
                    users.splice(userIndex, 1);
                }
                break;

            case "ROOM_DELETED":
                document.getElementById('room-deleted-modal').style.display = 'flex';
                return;

            case "ROLE_CHANGE":
                // ì—­í•  ë³€ê²½ ë¡œì§ (ë‚˜ì¤‘ì— êµ¬í˜„)
                break;

            default:
                // ì˜ˆìƒì¹˜ ëª»í•œ ì´ë²¤íŠ¸ íƒ€ì… ì²˜ë¦¬
                console.warn("Unknown user event type received:", userDto.eventType);
        }
        updateUserList(); // ìœ ì € ëª©ë¡ UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ í˜¸ì¶œ
    }

	// ìƒˆë¡œ ì¶”ê°€: ìœ ì € ëª©ë¡ UIë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
	function updateUserList() {
		userListElement.innerHTML = ''; // ê¸°ì¡´ ëª©ë¡ ë¹„ìš°ê¸°
		users.forEach(user => {
			const listItem = document.createElement('li');
			listItem.textContent = user.name;
            listItem.dataset.userId = user.id; // ì—¬ê¸°ì— userId ì €ì¥

            if( user.conn === "DISCONNECT" )
                listItem.style.color = "gray";
			userListElement.appendChild(listItem);
		});
        userCountElement.textContent = users.filter(user => user.conn === "CONNECT").length+"/"+users.length; // ì ‘ì† ì¤‘ì¸ ìœ ì € ìˆ˜ë§Œ ì¹´ìš´íŠ¸
	}

	// --- WebSocket/STOMP ê´€ë ¨ í•¨ìˆ˜ ì¶”ê°€ ë ---

	function initChat() {
        const lineHeight = getSingleLineHeight();
        const containerHeight = chatLogElement.clientHeight;
        // ëª‡ ì¤„ì„ ê°€ì ¸ì˜¬ì§€ ê³„ì‚°í•©ë‹ˆë‹¤. (í™”ë©´ì„ ê½‰ ì±„ìš°ê³  5ì¤„ì •ë„ ì—¬ìœ ë¶„ ì¶”ê°€)
        linesToLoad = Math.ceil(containerHeight / lineHeight) + 5;

		let url = SERVER_BASE_URL+"/room/"+roomId+`/init?lines=${linesToLoad}`;

		fetch(url, {
			method: 'GET',
            credentials: 'include',
		}).then(response => {
            // ì‘ë‹µì´ ì„±ê³µì ì¸ì§€ í™•ì¸í•©ë‹ˆë‹¤ (HTTP ìƒíƒœ ì½”ë“œ 200-299).
            if (!response.ok) {
                // ì‘ë‹µì´ ì‹¤íŒ¨í•˜ë©´ ì—ëŸ¬ë¥¼ í‘œì‹œí•˜ê³  ë¡œë¹„ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸.
                response.json().then(message => {
                    alert(message.message);
                    window.location.href = 'index.html';
                });
            }
            return response.json(); // JSON ì‘ë‹µì„ ê¸°ëŒ€
        }).then(data => {
            document.getElementById("output").textContent = "ë°© ì œëª©: "+data.roomName;

            data.users.forEach( user => {
                if( user.userId === id ) {
                    nickname = user.nickname;
                    nameboxInput.value = nickname;
                    role = user.role; // í˜„ì¬ ì‚¬ìš©ìì˜ ì—­í•  ì €ì¥
                }

                users.push({id: user.userId, name: user.nickname, role: user.role, conn: user.conn});
            });

            // ì—­í• ì´ ADMINì´ë©´ ë°© ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
            if (role === 'ADMIN') {
                document.getElementById('delete-room-button').style.display = 'inline-block';
                document.getElementById('exit-button').hidden = true;
            }

            data.messages.slice().reverse().forEach( message => {
                if( firstMessageId === null )
                    firstMessageId = message.messageId;
                displayMessage(message, 1);
            });

			connect();
            setupIntersectionObserver();
            observer.observe(topElement);
            isLoading = false;
        })
	}

    // í™”ë©´ì— ë©”ì‹œì§€ë¥¼ í‘œì‹œí•˜ëŠ” ë²”ìš© í•¨ìˆ˜
    // ê¸°ì¡´ getChatì˜ forEach ë£¨í”„ì™€ onMessageReceivedì—ì„œ ëª¨ë‘ ì‚¬ìš©í•˜ë„ë¡ í•¨ìˆ˜ ë¶„ë¦¬
    function displayMessage(message, append) {
        const listItem = document.createElement('li');
        listItem.classList.add('chat-message-item'); // ìŠ¤íƒ€ì¼ë§ì„ ìœ„í•œ í´ë˜ìŠ¤ ì¶”ê°€

        const profileImageUrl = message.authorProfileImageUrl ? `${SERVER_BASE_URL}${message.authorProfileImageUrl}` : `${SERVER_BASE_URL}/images/profiles/default.png`;

        const chatContainerWidth = document.getElementById("top-of-chat").clientWidth-75;   // 75ëŠ” í”„ë¡œí•„ ì‚¬ì§„ ì˜ì—­+ë§ˆì§„ í•˜ë“œì½”ë”©
        const maxHeight = (chatContainerWidth / 16) * 9;

        let messageBodyHtml;
        if (message.messageType === 'FILE') {
            const parts = message.content.split(':');
            const originalFilename = parts[0];
            const storedFilename = parts.slice(1).join(':');
            const downloadUrl = `${SERVER_BASE_URL}/files/chat/${storedFilename}`;

            // ì§€ì›í•  í™•ì¥ì ëª©ë¡
            const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'];
            const videoExtensions = ['mp4', 'webm', 'ogg'];
            const fileExtension = originalFilename.split('.').pop().toLowerCase();

            if (imageExtensions.includes(fileExtension)) {
                // ì´ë¯¸ì§€ íŒŒì¼ì¸ ê²½ìš°
                messageBodyHtml = `
                    <a href="${downloadUrl}" target="_blank" title="í´ë¦­í•´ì„œ ì›ë³¸ ë³´ê¸°: ${originalFilename}">
                        <img src="${downloadUrl}" alt="${originalFilename}" style="max-width: 100%; max-height: ${maxHeight}px; object-fit: contain; border-radius: 5px; cursor: pointer;" onload="this.closest('#chat-log').scrollTop = this.closest('#chat-log').scrollHeight">
                    </a>`;
            } else if (videoExtensions.includes(fileExtension)) {
                // ë™ì˜ìƒ íŒŒì¼ì¸ ê²½ìš°
                messageBodyHtml = `
                    <video controls style="max-width: 100%; max-height: ${maxHeight}px; border-radius: 5px;" onloadeddata="this.closest('#chat-log').scrollTop = this.closest('#chat-log').scrollHeight">
                        <source src="${downloadUrl}" type="video/${fileExtension}">
                        ë¸Œë¼ìš°ì €ê°€ ë¹„ë””ì˜¤ íƒœê·¸ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. <a href="${downloadUrl}" download="${originalFilename}">ì—¬ê¸°</a>ë¥¼ ëˆŒëŸ¬ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”.
                    </video>`;
            } else {
                // ì¼ë°˜ íŒŒì¼ì¸ ê²½ìš°
                messageBodyHtml = `<a href="${downloadUrl}" download="${originalFilename}">[íŒŒì¼] ${originalFilename}</a>`;
            }
        } else {
            // 1. XSS ë°©ì§€ë¥¼ ìœ„í•´ HTML íƒœê·¸ë¥¼ ë¨¼ì € ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
            let safeContent = escapeHtml(message.content);
            
            // 2. í…ìŠ¤íŠ¸ë¥¼ ë§í¬ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
            let processedContent = linkifyText(safeContent);

            // 3. ìœ íŠœë¸Œ ë§í¬ë¥¼ ì°¾ì•„ ì„ë² ë“œ í”Œë ˆì´ì–´ë¡œ ë¨¼ì € ë³€í™˜í•©ë‹ˆë‹¤.
            const youtubeRegex = /(<a href="https?:\/\/(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([\w\-]+)[^>]*">[^<]+<\/a>)/g;
            processedContent = processedContent.replace(youtubeRegex, (match, originalLink, videoId) => {
                // ìœ íŠœë¸Œ ë§í¬ëŠ” ì¼ë°˜ ë§í¬ ë¯¸ë¦¬ë³´ê¸°ì—ì„œ ì œì™¸ì‹œí‚¤ê¸° ìœ„í•´, ë§í¬ ìì²´ë¥¼ iframeìœ¼ë¡œ êµì²´í•©ë‹ˆë‹¤.
                return `<iframe style="width: ${chatContainerWidth}px; aspect-ratio: 16/9; border-radius: 8px; border: none; margin-top: 8px;" `+
                            `src="https://www.youtube.com/embed/${videoId}" `+
                            `title="YouTube video player"`+
                            `frameborder="0" `+
                            `allow="web-share" `+
                            `allowfullscreen></iframe>`;
            });

            // 4. ë‚˜ë¨¸ì§€ ë§í¬(ìœ íŠœë¸Œê°€ ì•„ë‹Œ) ì¤‘ì—ì„œ ì´ë¯¸ì§€/ë™ì˜ìƒ ë§í¬ë¥¼ ì°¾ì•„ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
            const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'];
            const videoExtensions = ['mp4', 'webm', 'ogg'];
            const linkRegex = /<a href="([^\"]+)"[^>]*>([^<]+)<\/a>/g;
            
            let finalContent = processedContent.replace(linkRegex, (match, url) => {
                try {
                    const pathWithoutQuery = url.split('?')[0].split('#')[0];
                    const extension = pathWithoutQuery.split('.').pop().toLowerCase();
                    const chatContainerWidth = chatLogElement.clientWidth;
                    const maxHeight = (chatContainerWidth / 16) * 9;

                    if (imageExtensions.includes(extension)) {
                        // ì´ë¯¸ì§€ ë§í¬ì¼ ê²½ìš°
                        return `${match}<br><img src="${url}" alt="Image from link" style="max-width: 100%; max-height: ${maxHeight}px; object-fit: contain; border-radius: 5px;" onload="this.closest('#chat-log').scrollTop = this.closest('#chat-log').scrollHeight">`;
                    } else if (videoExtensions.includes(extension)) {
                        // ë™ì˜ìƒ ë§í¬ì¼ ê²½ìš°
                        return `${match}<br><video controls style="max-width: 100%; max-height: ${maxHeight}px; border-radius: 5px;" onloadeddata="this.closest('#chat-log').scrollTop = this.closest('#chat-log').scrollHeight"><source src="${url}" type="video/${extension}"></video>`;
                    }
                } catch (e) {
                    console.error("Error processing URL for preview:", e);
                }
                // í•´ë‹¹ ì—†ìœ¼ë©´ ì›ë˜ ë§í¬(match)ë¥¼ ê·¸ëŒ€ë¡œ ë°˜í™˜í•©ë‹ˆë‹¤.
                return match;
            });

            messageBodyHtml = finalContent.replace(/\n/g, '<br>');
        }

        if (message.linkPreview && message.linkPreview.url) {
            const preview = message.linkPreview;
            const url = preview.url;
            const isYoutube = /youtube\.com|youtu\.be/.test(url); // ìœ íŠœë¸Œ ë§í¬ì¸ì§€ í™•ì¸

            // ìœ íŠœë¸Œ ë§í¬ê°€ ì•„ë‹ ê²½ìš°ì—ë§Œ ë¯¸ë¦¬ë³´ê¸° ì¹´ë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
            if (!isYoutube) {
                const displayUrl = url.length > 50 ? url.slice(0, 47) + '...' : url;

                linkPreviewHtml = `
                    <a href="${url}" target="_blank" class="link-preview-card">
                        ${preview.imageUrl ? `<img src="${preview.imageUrl}" class="link-preview-image" alt="Preview" onerror="this.style.display='none';">` : ''}
                        <div class="link-preview-info">
                            <div class="link-preview-title">${escapeHtml(preview.title || '')}</div>
                            <div class="link-preview-description">${escapeHtml(preview.description || '')}</div>
                            <div class="link-preview-url">${escapeHtml(displayUrl)}</div>
                        </div>
                    </a>
                `;
            }
        }

        listItem.innerHTML = `
            <img src="${profileImageUrl}" class="chat-profile-img" alt="profile">
            <div class="chat-message-content">
                <div class="chat-message-header">
                    <strong class="chat-author-name">${message.authorName}</strong>
                    <span class="chat-timestamp">${message.createdAt || ''}</span>
                </div>
                <div class="chat-message-body">
                    ${messageBodyHtml}
                    <div class="link-preview-container" id="preview-for-${message.messageId}"></div> <!-- ë¯¸ë¦¬ë³´ê¸° ì¹´ë“œê°€ ì‚½ì…ë  ì»¨í…Œì´ë„ˆ -->
                </div>
            </div>
        `;
        if( append !== 0 ){
            chatLogElement.appendChild(listItem); // ulì˜ ëì— li ì¶”ê°€
            chatLogElement.scrollTop = chatLogElement.scrollHeight; // ìŠ¤í¬ë¡¤ì„ í•­ìƒ ìµœí•˜ë‹¨ìœ¼ë¡œ ë‚´ë¦½ë‹ˆë‹¤.
        } else {
            const topMarker = document.getElementById('top-of-chat');
            if (topMarker) {
                chatLogElement.insertBefore(listItem, topMarker.nextSibling); // ë§ˆì»¤ ë°”ë¡œ ë’¤ì— ì‚½ì…
            } else {
                chatLogElement.prepend(listItem); // ë§ˆì»¤ê°€ ì—†ìœ¼ë©´ ê·¸ëƒ¥ ë§¨ ì•ì— ì¶”ê°€ (fallback)
            }
            firstMessageId = message.messageId;
            // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ëŠ” ìœ ì§€í•˜ê±°ë‚˜, ìƒˆë¡œ ì¶”ê°€ëœ ë©”ì‹œì§€ë“¤ì´ ë³´ì´ë„ë¡ ì¡°ì •í•´ì•¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            // ì—¬ê¸°ì„œëŠ” ìŠ¤í¬ë¡¤ ìœ„ì¹˜ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ë³€ê²½í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (ìƒˆ ë©”ì‹œì§€ ë¡œë“œ ì‹œ ìŠ¤í¬ë¡¤ ìœ ì§€)
        }
        chatCount++;
    }

	// --- ê¸°ì¡´ send í•¨ìˆ˜ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€ (HTTP POSTë¡œ ë©”ì‹œì§€ ì „ì†¡) ---
	function send(){
        const messageContent = messageInput.value.trim(); // messageInputì€ <input id="box">

        // ë©”ì‹œì§€ ë‚´ìš©ì´ ë¹„ì–´ìˆìœ¼ë©´ ì „ì†¡í•˜ì§€ ì•ŠìŒ
        if (messageContent && stompClient) {
            // 1. ì„œë²„ì˜ ChatMessageRequestDto í˜•ì‹ì— ë§ì¶° JSON ê°ì²´ ìƒì„±
            const chatMessage = {
                roomId: roomId,
                authorId: id,
                content: messageContent,
                messageType: 'TEXT' // ì¼ë°˜ í…ìŠ¤íŠ¸ ë©”ì‹œì§€
            };

            stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));
            messageInput.value = "";
        }
	}

	function nick(newNick){
        if( getByteLength(newNick) === 0 ){
            displayMessage({id: "", name: "system", chat: "ë‹‰ë„¤ì„ì´ ë„ˆë¬´ ì§§ì•„ìš”.", timestamp: ""});
        } else if ( getByteLength(newNick) > 22 ){
            displayMessage({id: "", name: "system", chat: "ë‹‰ë„¤ì„ì´ ë„ˆë¬´ ê¸¸ì–´ìš”.", timestamp: ""});
        } else if (users.some(user => user.name === newNick)) {
            displayMessage({id: "", name: "system", chat: "ì¤‘ë³µëœ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.", timestamp: ""});
        }
        else {
            const nickChange = {
                roomId: roomId,
                userId: id,
                newNickname: newNick
            };

            stompClient.send("/app/chat.changeNick", {}, JSON.stringify(nickChange));
            return;
        }
        nameboxInput.value = nickname; // ì›ë˜ ë‹‰ë„¤ì„ìœ¼ë¡œ ë˜ëŒë¦¼
	}

	function clear(){
		document.getElementById("chat-log").innerHTML = '';
    }

    function setupIntersectionObserver() {
        observer = new IntersectionObserver((entries, observer) => {
            const entry = entries[0];

            if (entry.isIntersecting && !isLoading && chatCount >= linesToLoad) {
                console.log("ì¶”ê°€ ë©”ì‹œì§€ ë¡œë“œ ìš”ì²­");
                loadMoreMessage();
            }
        }, {root: chatLogElement, rootMargin: '-1px 0px 0px 0px', threshold: 0});
    }

    function loadMoreMessage(){
        if (isLoading) return;
        isLoading = true;

        if (observer) observer.unobserve(topElement);

        const msgRequest = {
            roomId: roomId,
            beginId: firstMessageId,    // firstMessageId
            rowCount: linesToLoad       // how much need
        };

        stompClient.send("/app/chat.getMessageList", {}, JSON.stringify(msgRequest));
    }

    function exitRoom() {
        if(confirm("ì •ë§ ë°©ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            const url = `${SERVER_BASE_URL}/room/${roomId}/users`;

            fetch(url, {
                method: 'DELETE',
                credentials: 'include' // ì„¸ì…˜ ì¿ í‚¤ë¥¼ ë³´ë‚´ê¸° ìœ„í•´ í•„ìš”
            })
            .then(response => {
                if (!response.ok) {
                    // ì¦‰ì‹œ ì—ëŸ¬ë¥¼ ì²˜ë¦¬í•´ì•¼ í•˜ëŠ” ê²½ìš° (ì˜ˆ: ê¶Œí•œ ì—†ìŒ)
                    return response.json().then(err => { 
                        throw new Error(err.message || 'ë‚˜ê°€ê¸° ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); 
                    });
                }
                console.log("ë‚˜ê°€ê¸° ìš”ì²­ì„ ì„±ê³µì ìœ¼ë¡œ ë³´ëƒˆìŠµë‹ˆë‹¤. ì„œë²„ì˜ ROOM_OUT ì´ë²¤íŠ¸ë¥¼ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.");
            })
            .catch(error => {
                console.error('Error sending exit request:', error);
                alert(error.message);
            });
        }
    }

    function deleteRoom() {
        if(confirm("ì •ë§ë¡œ ë°©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ëŒ€í™” ë‚´ìš©ì´ ì‚¬ë¼ì§€ê³ , í˜„ì¬ ì ‘ì† ì¤‘ì¸ ë©¤ë²„ë“¤ì€ ë°©ì—ì„œ ë‚˜ê°€ê²Œ ë©ë‹ˆë‹¤.")) {
            const url = `${SERVER_BASE_URL}/room/${roomId}`;

            fetch(url, {
                method: 'DELETE',
                credentials: 'include'
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.message || 'ë°© ì‚­ì œ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    });
                }
                // ì„±ê³µì ìœ¼ë¡œ ìš”ì²­ì„ ë³´ëƒˆìœ¼ë¯€ë¡œ, ì„œë²„ë¡œë¶€í„° ROOM_DELETED ì´ë²¤íŠ¸ë¥¼ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.
                console.log("ë°© ì‚­ì œ ìš”ì²­ì„ ì„±ê³µì ìœ¼ë¡œ ë³´ëƒˆìŠµë‹ˆë‹¤.");
            })
            .catch(error => {
                console.error('Error deleting room:', error);
                alert(error.message);
            });
        }
    }

	// --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë° ì´ˆê¸° í˜¸ì¶œ ---
	document.getElementById('box').addEventListener('keydown', (event) => {
		if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault(); // ìƒˆ ì¤„ ì‚½ì… ë°©ì§€
            // íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°ê°€ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ì „ì†¡ ë²„íŠ¼ í´ë¦­, ì•„ë‹ˆë©´ ì¼ë°˜ ë©”ì‹œì§€ ì „ì†¡
            if (document.getElementById('file-preview-container').style.display !== "") {
                document.getElementById('file-confirm-upload-btn').click();
            } else {
                send();
            }
        }
	});
	document.getElementById('namebox').addEventListener('keydown', (event) => {
		if (event.key === 'Enter' || event.keyCode === 13) {
			document.getElementById('namebox').blur();
		}
	});

	document.getElementById('namebox').addEventListener('change', (event) => {
// /chat/nick ë³´ë‚´ê¸°
		nick(nameboxInput.value);
	});

	document.addEventListener('DOMContentLoaded', function(){
        document.getElementById('exit-button').addEventListener('click', exitRoom);
        document.getElementById('delete-room-button').addEventListener('click', deleteRoom);
        document.getElementById('go-to-lobby-btn').addEventListener('click', () => {
            window.location.href = 'index.html';
        });

        // --- í”„ë¡œí•„ íŒì˜¤ë²„ ë‹«ê¸° ë¡œì§ ---
        // 1. X ë²„íŠ¼ í´ë¦­ ì‹œ
        document.getElementById('popover-close').addEventListener('click', () => {
            profilePopover.style.display = 'none';
        });

        // 2. íŒì˜¤ë²„ ë°”ê¹¥ ì˜ì—­ í´ë¦­ ì‹œ
        document.addEventListener('click', (event) => {
            // í´ë¦­ëœ ìš”ì†Œê°€ íŒì˜¤ë²„ ìì‹ ì´ ì•„ë‹ˆê³ ,
            // ì‚¬ìš©ì ëª©ë¡(user-list)ì˜ ìì‹ ìš”ì†Œë„ ì•„ë‹ ë•Œë§Œ ë‹«ìŠµë‹ˆë‹¤.
            if (!profilePopover.contains(event.target) && !userListElement.contains(event.target)) {
                profilePopover.style.display = 'none';
            }
        });

        // ì‚¬ìš©ì ëª©ë¡ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        userListElement.addEventListener('click', (event) => {
            const listItem = event.target.closest('li'); // í´ë¦­ëœ li ìš”ì†Œë¥¼ ì°¾ìŒ
            if (listItem && listItem.dataset.userId) {
                const clickedUserId = listItem.dataset.userId;
                showUserProfile(clickedUserId, listItem); // í”„ë¡œí•„ í‘œì‹œ í•¨ìˆ˜ í˜¸ì¶œ
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ìƒíƒœë¥¼ í™•ì¸í•˜ëŠ” í•¨ìˆ˜
        function checkLoginStatus() {
            fetch(`${SERVER_BASE_URL}/auth/session`, { method: 'GET', credentials: 'include' })
                .then(response => {
                    if (!response.ok) {
                        // 4xx, 5xx ì—ëŸ¬ ë°œìƒ ì‹œ ë¡œê·¸ì¸ë˜ì§€ ì•Šì€ ìƒíƒœë¡œ ê°„ì£¼
                        // ì„œë²„ê°€ ë³´ë‚¸ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í™•ì¸í•˜ê³  ì‹¶ë‹¤ë©´ response.json()ì„ ì‚¬ìš©
                        return response.json().then(err => { throw err; });
                    }
                    return response.json(); // ì„±ê³µ ì‹œ LoginResponseDtoë¥¼ íŒŒì‹±
                })
                .then(userData => {
                    // ì„±ê³µì ìœ¼ë¡œ ì‚¬ìš©ì ì •ë³´ë¥¼ ë°›ìœ¼ë©´, ë‹¤ìŒë‹¨ê³„ë¡œ
                    id = userData.userId;
                    username = userData.username;
                    initChat();
                })
                .catch(error => {
                    // ë¡œê·¸ì¸ë˜ì§€ ì•Šì€ ìƒíƒœì´ë¯€ë¡œ ë¡œë¹„ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                    alert('ì„¸ì…˜ í™•ì¸ ê²°ê³¼: ë¡œê·¸ì¸ë˜ì§€ ì•ŠìŒ.');
                    window.location.href = 'index.html';
                });
        }

        checkLoginStatus();
    });

    function escapeHtml(unsafe) {
        return unsafe
             .replace(/&/g, "&amp;")
             .replace(/</g, "&lt;")
             .replace(/>/g, "&gt;")
             .replace(/"/g, "&quot;")
             .replace(/'/g, "&#039;");
    }

    function getByteLength(str) {
        return new TextEncoder().encode(str).length;
    }

    function linkifyText(plainText) {
        if (!plainText) return '';
        let replacedText;
        // URLs starting with http://, https://, or ftp://
        const urlPattern = /(\b(https?|ftp):\/\/[\-A-Z0-9+&@#\/%?=~_|!:,.;]*[\-A-Z0-9+&@#\/%?=~_|])/gim;
        replacedText = plainText.replace(urlPattern, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');

        // URLs starting with "www." (without http:// or https://)
        const wwwPattern = /(^|[^/\w])(www\.[\S]+(\b|$))/gim;
        replacedText = replacedText.replace(wwwPattern, '$1<a href="http://$2" target="_blank" rel="noopener noreferrer">$2</a>');

        return replacedText;
    }

	function isValidUrl(str) {
        try {
            const url = new URL(str);
            // http: ë˜ëŠ” https: í”„ë¡œí† ì½œë§Œ í—ˆìš©í•˜ë ¤ë©´ ì•„ë˜ ì¡°ê±´ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            return url.protocol === 'http:' || url.protocol === 'https:';
        } catch (e) {
            // URL ê°ì²´ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©´ ìœ íš¨í•˜ì§€ ì•Šì€ URLë¡œ íŒë‹¨
            return false;
        }
	}

    function getSingleLineHeight() {
        // ì„ì‹œë¡œ li ìš”ì†Œë¥¼ í•˜ë‚˜ ë§Œë“¤ì–´ì„œ ë†’ì´ë¥¼ ì¸¡ì •í•˜ê³  ì‚­ì œí•˜ëŠ” ë°©ì‹
        const tempLi = document.createElement('li');
        // í™”ë©´ì— ë³´ì´ì§€ ì•Šë„ë¡ ìŠ¤íƒ€ì¼ ì„¤ì •
        tempLi.style.visibility = 'hidden';
        tempLi.style.position = 'absolute';
        tempLi.innerHTML = 'Sample'; // ë‚´ìš©ë¬¼ì€ ì¤‘ìš”í•˜ì§€ ì•ŠìŒ

        document.body.appendChild(tempLi);
        const lineHeight = tempLi.offsetHeight; // padding, border í¬í•¨í•œ ì‹¤ì œ ë†’ì´
        document.body.removeChild(tempLi); // ì¸¡ì • í›„ ì‚­ì œ

        return lineHeight > 0 ? lineHeight : 18; // ë§Œì•½ ì¸¡ì •ì´ ì•ˆë˜ë©´ ê¸°ë³¸ê°’ 18px ë°˜í™˜
    }

    function showUserProfile(userId, targetElement) {
        const url = `${SERVER_BASE_URL}/user/${userId}/profile`;

        fetch(url, {
            method: 'GET',
            credentials: 'include'
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.message || 'í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'); });
            }
            return response.json();
        })
        .then(userProfile => {
            // íŒì˜¤ë²„ ë‚´ìš© ì±„ìš°ê¸°
            document.getElementById('popover-profile-img').src = SERVER_BASE_URL + userProfile.imageUrl;
            document.getElementById('popover-nickname').textContent = targetElement.textContent;
            document.getElementById('popover-username').textContent = userProfile.username;
            document.getElementById('popover-userid').textContent = userProfile.nickname;
            document.getElementById('popover-status').textContent = userProfile.status_msg || '(ìƒíƒœ ë©”ì‹œì§€ ì—†ìŒ)';

            // íŒì˜¤ë²„ ìœ„ì¹˜ë¥¼ ê³„ì‚°í•˜ê¸° ì „ì— ë¨¼ì € ë³´ì´ê²Œ ë§Œë“¤ì–´ì•¼ ì •í™•í•œ offsetWidthë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            // ë‹¨, íˆ¬ëª…í•˜ê²Œ ë§Œë“¤ì–´ ê¹œë¹¡ì„ì„ ë°©ì§€í•©ë‹ˆë‹¤.
            profilePopover.style.visibility = 'hidden';
            profilePopover.style.display = 'block';

            // íŒì˜¤ë²„ ìœ„ì¹˜ ê³„ì‚°
            const rect = targetElement.getBoundingClientRect();
            const popoverWidth = profilePopover.offsetWidth;

            // íŒì˜¤ë²„ì˜ ì˜¤ë¥¸ìª½ ëì„ li ìš”ì†Œì˜ ì˜¤ë¥¸ìª½ ëì— ë§ì¶¥ë‹ˆë‹¤.
            profilePopover.style.top = `${rect.top}px`;
            profilePopover.style.left = `${rect.right - popoverWidth}px`; 

            // ì´ì œ íŒì˜¤ë²„ë¥¼ ì™„ì „íˆ ë³´ì´ê²Œ í•©ë‹ˆë‹¤.
            profilePopover.style.visibility = 'visible';
        })
        .catch(error => {
            console.error('Error fetching user profile:', error);
            // ì—ëŸ¬ ë°œìƒ ì‹œ íŒì˜¤ë²„ë¥¼ ë‹¤ì‹œ ìˆ¨ê¹ë‹ˆë‹¤.
            profilePopover.style.display = 'none';
        });
    }

    // --- íŒŒì¼ ì—…ë¡œë“œ ê´€ë ¨ ë¡œì§ (ê°œë³„ ì‚­ì œ ì¶”ê°€) ---
    const fileInput = document.getElementById('file-input');
    const previewContainer = document.getElementById('file-preview-container');
    const imagePreviewArea = document.getElementById('file-preview-image-area');
    const listPreviewArea = document.getElementById('file-preview-list-area');
    const filePreviewInfo = document.getElementById('file-preview-info');
    const cancelBtn = document.getElementById('file-cancel-btn');
    const confirmBtn = document.getElementById('file-confirm-upload-btn');
    const dropZone = document.getElementById('chat-main-container');

    let filesToUpload = [];
    const MAX_FILES = 5;

    // íŒŒì¼ ì¶”ê°€ (í´ë¦­ ë˜ëŠ” ë“œë˜ê·¸ì•¤ë“œë¡­)
    function addFiles(newFiles) {
        const fileList = Array.from(newFiles);

        for (const file of fileList) {
            if (filesToUpload.length >= MAX_FILES) {
                alert(`íŒŒì¼ì€ ìµœëŒ€ ${MAX_FILES}ê°œê¹Œì§€ ì²¨ë¶€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                break;
            }
            if (!filesToUpload.some(f => f.name === file.name && f.size === file.size)) {
                 filesToUpload.push(file);
            }
        }
        renderPreviews();
        // inputì˜ ê°’ì„ ì´ˆê¸°í™”í•˜ì—¬ ê°™ì€ íŒŒì¼ì„ ë‹¤ì‹œ ì„ íƒí•´ë„ change ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ë„ë¡ í•¨
        fileInput.value = '';
    }

    // ë¯¸ë¦¬ë³´ê¸° ë Œë”ë§
    function renderPreviews() {
        imagePreviewArea.innerHTML = '';
        listPreviewArea.innerHTML = '';

        if (filesToUpload.length === 0) {
            previewContainer.style.display = 'none';
            return;
        }

        filesToUpload.forEach((file, index) => {
            const removeBtn = document.createElement('span');
            removeBtn.className = 'remove-file-btn';
            removeBtn.innerHTML = '&times;';
            removeBtn.onclick = () => removeFile(index);

            if (file.type.startsWith('image/')) {
                const wrapper = document.createElement('div');
                wrapper.className = 'preview-image-wrapper';
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.title = file.name;
                    wrapper.appendChild(img);
                    wrapper.appendChild(removeBtn);
                    imagePreviewArea.appendChild(wrapper);
                }
                reader.readAsDataURL(file);
            } else {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-preview-item';
                const fileName = document.createElement('span');
                fileName.textContent = `ğŸ“„ ${file.name}`;
                fileItem.appendChild(fileName);
                fileItem.appendChild(removeBtn);
                listPreviewArea.appendChild(fileItem);
            }
        });

        filePreviewInfo.textContent = `${filesToUpload.length}ê°œ íŒŒì¼ ì„ íƒë¨`;
        previewContainer.style.display = 'block';
        messageInput.focus();
    }

    // íŠ¹ì • íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°ì—ì„œ ì œê±°
    function removeFile(indexToRemove) {
        filesToUpload.splice(indexToRemove, 1);
        renderPreviews();
    }

    // ë¯¸ë¦¬ë³´ê¸° ì „ì²´ ì·¨ì†Œ
    function hidePreview() {
        filesToUpload = [];
        renderPreviews();
    }

    // ëª¨ë“  íŒŒì¼ ì—…ë¡œë“œ ì‹¤í–‰
    async function uploadAllFiles(files) {
        const uploadBtn = document.getElementById('file-upload-btn');
        uploadBtn.style.pointerEvents = 'none';
        uploadBtn.textContent = '...';

        for (const file of files) {
            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`${SERVER_BASE_URL}/room/${roomId}/file`, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.message || 'íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                console.log(`${file.name} uploaded successfully`);
            } catch (error) {
                console.error('File upload error:', error);
                alert(`${file.name} ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
                break; 
            }
        }
        uploadBtn.style.pointerEvents = 'auto';
        uploadBtn.textContent = 'ğŸ“';
        hidePreview();
    }

    // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° ---
    fileInput.addEventListener('change', (event) => {
        addFiles(event.target.files);
    });

    cancelBtn.addEventListener('click', hidePreview);

    confirmBtn.addEventListener('click', () => {
        if (filesToUpload.length > 0) {
            uploadAllFiles(filesToUpload);
        }
    });

    dropZone.addEventListener('dragover', (event) => {
        event.preventDefault();
        dropZone.style.backgroundColor = '#f0f8ff';
    });

    dropZone.addEventListener('dragleave', (event) => {
        event.preventDefault();
        dropZone.style.backgroundColor = '';
    });

    dropZone.addEventListener('drop', (event) => {
        event.preventDefault();
        dropZone.style.backgroundColor = '';
        addFiles(event.dataTransfer.files);
    });

    document.addEventListener('paste', (event) => {
        const items = (event.clipboardData || event.originalEvent.clipboardData).items;
        let imageFile = null;
        for (const item of items) {
            if (item.kind === 'file' && item.type.startsWith('image/')) {
                imageFile = item.getAsFile();
                break;
            }
        }

        if (imageFile) {
            event.preventDefault();
            addFiles([imageFile]);
        }
    });

</script>
