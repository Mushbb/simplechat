<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SQL 쿼리 전송 및 결과 테이블</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #queryInput { width: 80%; padding: 8px; margin-bottom: 10px; }
    #executeQuery { padding: 10px 20px; background-color: #007bff; color: white; border: none; cursor: pointer; border-radius: 5px; }
    #executeQuery:hover { background-color: #0056b3; }
    #resultTableContainer { margin-top: 20px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    .error-message { color: red; margin-top: 10px; }
  </style>
</head>
<body>
<h1>SQL 쿼리 실행</h1>

<textarea id="queryInput" rows="5" placeholder="SQL 쿼리를 입력하세요. 예: SELECT id, name, age FROM users"></textarea><br>
<button id="executeQuery">쿼리 실행</button>
<div id="errorMessage" class="error-message"></div>

<div id="resultTableContainer">
  <h2>쿼리 결과</h2>
  <p id="noResultText">아직 결과가 없습니다.</p>
  <table id="dataTable">
    <thead>
    <tr id="tableHeader"></tr>
    </thead>
    <tbody id="tableBody">
    </tbody>
  </table>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const queryInput = document.getElementById('queryInput');
    const executeQueryBtn = document.getElementById('executeQuery');
    const errorMessageDiv = document.getElementById('errorMessage');
    const noResultText = document.getElementById('noResultText');
    const dataTable = document.getElementById('dataTable');
    const tableHeader = document.getElementById('tableHeader');
    const tableBody = document.getElementById('tableBody');

    const SERVER_URL = 'http://10.50.131.25:8080/shop';//'http://localhost:8080/shop'; // 서버 주소

    // 초기 상태 설정
    dataTable.style.display = 'none';
    noResultText.style.display = 'block';
    errorMessageDiv.textContent = '';

    executeQueryBtn.addEventListener('click', async () => {
      const sqlQueryString = queryInput.value.trim(); // SQL 쿼리 문자열을 그대로 가져옴
      errorMessageDiv.textContent = ''; // 에러 메시지 초기화

      if (!sqlQueryString) {
        errorMessageDiv.textContent = 'SQL 쿼리를 입력해주세요.';
        return;
      }

      console.log('서버로 보낼 SQL 쿼리 (문자열):', sqlQueryString);

      try {
        const response = await fetch(SERVER_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'  // 서버에 JSON 데이터를 보낼 것임을 알립니다.
          },
          body: new URLSearchParams({
            sqlQuery: sqlQueryString      // sqlQuery 파라미터로 송신
          })
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP 오류! 상태: ${response.status}, 메시지: ${errorText}`);
        }

        // 서버 응답이 JSON 형식일 것이므로, JSON으로 파싱
        const result = await response.json();
        console.log('서버로부터 받은 응답:', result);
        
        if (Array.isArray(result)) { // result 자체가 배열인지 바로 확인
          if (result.length > 0) {
            const headersLine = result[0]; // 첫 줄이 헤더
            const dataLines = result.slice(1); // 나머지 줄이 데이터
            renderTable(headersLine, dataLines);
          } else {
            errorMessageDiv.textContent = '조회된 데이터가 없습니다.'; // 데이터는 없지만 성공 응답인 경우
            renderTable('', []);
          }
        } else {
          errorMessageDiv.textContent = '서버 응답 형식이 예상과 다릅니다. (JSON 배열이 아닙니다.)';
          renderTable('', []);
        }

      } catch (error) {
        console.error('Fetch 오류:', error);
        errorMessageDiv.textContent = `서버와 통신 중 오류 발생: ${error.message}. 서버가 실행 중인지 확인해주세요.`;
        renderTable('', []);
      }
    });

    // renderTable 함수: headersLine (탭 구분 문자열)과 dataLines (탭 구분 문자열 배열)을 받음
    function renderTable(headersLine, dataLines) {
      tableHeader.innerHTML = '';
      tableBody.innerHTML = '';

      if (!headersLine || dataLines.length === 0) {
        dataTable.style.display = 'none';
        noResultText.style.display = 'block';
        return;
      }

      noResultText.style.display = 'none';
      dataTable.style.display = 'table';

      const headers = headersLine.split('\t');
      headers.forEach(headerText => {
        const th = document.createElement('th');
        th.textContent = headerText;
        tableHeader.appendChild(th);
      });

      dataLines.forEach(dataLine => {
        const cells = dataLine.split('\t');
        const tr = document.createElement('tr');
        cells.forEach(cellText => {
          const td = document.createElement('td');
          td.textContent = cellText;
          tr.appendChild(td);
        });
        tableBody.appendChild(tr);
      });
    }
  });
</script>
</body>
</html>