<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±„íŒ… ë¡œë¹„</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 50px;
            background-color: #f0f2f5;
        }
        #lobby-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 80%;
            max-width: 600px;
            text-align: center;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        #room-list {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
            text-align: left;
        }
        #room-list ul {
            list-style: none;
            padding: 0;
            max-height: 300px;
            overflow-y: auto;
        }
        #room-list li {
            background-color: #e9ebee;
            margin-bottom: 10px;
            padding: 10px 15px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #room-list li a {
            text-decoration: none;
            color: #007bff;
            font-weight: bold;
            font-size: 1.1em;
            flex-grow: 1; /* ë§í¬ê°€ ê³µê°„ì„ ë‹¤ ì°¨ì§€í•˜ë„ë¡ */
            text-align: left;
        }
        #room-list li a:hover {
            text-decoration: underline;
        }
        .room-count {
            font-size: 0.9em;
            color: #666;
        }
        #create-room-button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 20px;
        }
        #create-room-button:hover {
            background-color: #218838;
        }
        .no-rooms {
            color: #888;
            font-style: italic;
            margin-top: 10px;
        }

        /* ëª¨ë‹¬ ì „ì²´ë¥¼ ë®ëŠ” ì–´ë‘ìš´ ë°°ê²½ (ì˜¤ë²„ë ˆì´) */
        .modal-overlay {
            display: none; /* í‰ì†Œì—ëŠ” ìˆ¨ê¹€ */
            position: fixed; /* í™”ë©´ì— ê³ ì • */
            z-index: 1000; /* ë‹¤ë¥¸ ìš”ì†Œë“¤ ìœ„ì— ìˆë„ë¡ ì„¤ì • */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; /* ìŠ¤í¬ë¡¤ì´ í•„ìš”í•  ê²½ìš° */
            background-color: rgba(0, 0, 0, 0.6); /* ë°˜íˆ¬ëª… ê²€ì€ìƒ‰ ë°°ê²½ */
            /* Flexboxë¥¼ ì´ìš©í•´ ë‚´ìš©ë¬¼ì„ ì¤‘ì•™ ì •ë ¬ */
            justify-content: center;
            align-items: center;
        }

        /* ëª¨ë‹¬ ë‚´ìš©ë¬¼ì´ ë“¤ì–´ê°€ëŠ” í°ìƒ‰ ë°•ìŠ¤ */
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px 30px 30px;
            border: 1px solid #888;
            width: 80%;
            max-width: 400px;
            border-radius: 8px;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
            position: relative;
        }

        /* ë‹«ê¸° ë²„íŠ¼ (X) */
        .close-btn {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* í¼ ê·¸ë£¹ ìŠ¤íƒ€ì¼ */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box; /* íŒ¨ë”©ì´ ë„ˆë¹„ì— í¬í•¨ë˜ë„ë¡ ì„¤ì • */
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        /* ì œì¶œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .submit-btn {
            width: 100%;
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            margin-top: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        .submit-btn:hover {
            background-color: #45a049;
        }

        /* ì—ëŸ¬ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .error-message {
            color: red;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
            height: 1em; /* ë©”ì‹œì§€ê°€ ì—†ì„ ë•Œë„ ê³µê°„ ì°¨ì§€ */
        }

        /* ë¡œê·¸ì¸/íšŒì›ê°€ì… ë²„íŠ¼ ì»¨í…Œì´ë„ˆ */
        .auth-buttons {
            padding: 20px;
            text-align: center;
        }

        .modal-trigger-btn {
            padding: 10px 20px;
            font-size: 16px;
            margin: 0 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
<div id="lobby-container">
    <h1>ì±„íŒ… ë¡œë¹„</h1>
    <button id="create-room-button">ìƒˆ ì±„íŒ…ë°© ë§Œë“¤ê¸°</button>
    <div id="room-list">
        <h2>ê°œì„¤ëœ ì±„íŒ…ë°©</h2>
        <ul id="rooms">
            <li class="no-rooms">í˜„ì¬ ê°œì„¤ëœ ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</li>
        </ul>
    </div>
</div>

<!-- ================================================== -->
<!-- ======== ë¡œê·¸ì¸/íšŒì›ê°€ì… ë²„íŠ¼ ë° ëª¨ë‹¬ UI ì‹œì‘ ======== -->
<!-- ================================================== -->

<!-- 1. ë¡œê·¸ì¸/íšŒì›ê°€ì… ë²„íŠ¼ -->
<div class="auth-buttons">
    <button id="loginBtn" class="modal-trigger-btn">ë¡œê·¸ì¸</button>
    <button id="registerBtn" class="modal-trigger-btn">íšŒì›ê°€ì…</button>
</div>

<!-- 2. ë¡œê·¸ì¸ ëª¨ë‹¬ -->
<div id="loginModal" class="modal-overlay">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2>ë¡œê·¸ì¸</h2>
        <form id="loginForm" method="POST">
            <div class="form-group">
                <label for="loginUsername">ì•„ì´ë””</label>
                <input type="text" id="loginUsername" name="username" required>
            </div>
            <div class="form-group">
                <label for="loginPassword">ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="loginPassword" name="password" required>
            </div>
            <button type="submit" class="submit-btn">ë¡œê·¸ì¸</button>
            <p id="loginError" class="error-message"></p>
        </form>
    </div>
</div>

<!-- 3. íšŒì›ê°€ì… ëª¨ë‹¬ -->
<div id="registerModal" class="modal-overlay">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2>íšŒì›ê°€ì…</h2>
        <form id="registerForm" method="POST">
            <div class="form-group">
                <label for="regUsername">ì•„ì´ë””</label>
                <input type="text" id="regUsername" name="username" required>
            </div>
            <div class="form-group">
                <label for="regNickname">ë‹‰ë„¤ì„</label>
                <input type="text" id="regNickname" name="nickname" required>
            </div>
            <div class="form-group">
                <label for="regPassword">ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="regPassword" name="password" required>
            </div>
            <button type="submit" class="submit-btn">ê°€ì…í•˜ê¸°</button>
            <p id="registerError" class="error-message"></p>
        </form>
    </div>
</div>

<!-- 4. ìƒˆ ì±„íŒ…ë°© ë§Œë“¤ê¸° ëª¨ë‹¬ -->
<div id="createRoomModal" class="modal-overlay">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2>ìƒˆ ì±„íŒ…ë°© ë§Œë“¤ê¸°</h2>
        <form id="createRoomForm" method="POST">
            <div class="form-group">
                <label for="roomName">ë°© ì´ë¦„</label>
                <input type="text" id="roomName" name="roomName" required>
            </div>
            <div class="form-group">
                <label>ë°© íƒ€ì…</label><br>
                <input type="radio" id="roomTypePublic" name="roomType" value="PUBLIC" checked>
                <label for="roomTypePublic" style="margin-top: -22px;">ê³µê°œë°©</label><br>
                <input type="radio" id="roomTypePrivate" name="roomType" value="PRIVATE">
                <label for="roomTypePrivate" style="margin-top: -22px;">ë¹„ë°€ë°©</label><br>
                <input type="radio" id="roomTypeGame" name="roomType" value="GAME">
                <label for="roomTypeGame" style="margin-top: -22px;">ê²Œì„ë°©</label><br>
            </div>
            <div class="form-group" id="passwordGroup" style="display: none;">
                <label for="roomPassword">ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="roomPassword" name="password">
            </div>
            <button type="submit" class="submit-btn">ë°© ë§Œë“¤ê¸°</button>
            <p id="createRoomError" class="error-message"></p>
        </form>
    </div>
</div>


<!-- ================================================== -->
<!-- ========= ë¡œê·¸ì¸/íšŒì›ê°€ì… ë²„íŠ¼ ë° ëª¨ë‹¬ UI ë ========= -->
<!-- ================================================== -->

<script>
    let SERVER_BASE_URL = 'http://10.50.131.25:8080'; // <-- ì„œë²„ ì£¼ì†Œ í™•ì¸
    SERVER_BASE_URL = "http://localhost:8080";

    document.addEventListener('DOMContentLoaded', function() {
        const roomsUl = document.getElementById('rooms');
        const createRoomButton = document.getElementById('create-room-button');
        // existingRoomsë¥¼ Map<String, boolean> ë˜ëŠ” Set<String>ìœ¼ë¡œ ë³€ê²½í•˜ì—¬ ì¤‘ë³µ ì²´í¬ì— ìš©ì´í•˜ê²Œ
        let existingRoomNames = new Set(); // ë°© ì´ë¦„ë§Œ ì €ì¥í•˜ëŠ” Set

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ìƒíƒœë¥¼ í™•ì¸í•˜ëŠ” í•¨ìˆ˜
        function checkLoginStatus() {
            fetch(`${SERVER_BASE_URL}/auth/session`, { method: 'POST', credentials: 'include' })
                .then(response => {
                    if (!response.ok) {
                        // 4xx, 5xx ì—ëŸ¬ ë°œìƒ ì‹œ ë¡œê·¸ì¸ë˜ì§€ ì•Šì€ ìƒíƒœë¡œ ê°„ì£¼
                        // ì„œë²„ê°€ ë³´ë‚¸ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í™•ì¸í•˜ê³  ì‹¶ë‹¤ë©´ response.json()ì„ ì‚¬ìš©
                        return response.json().then(err => { throw err; });
                    }
                    return response.json(); // ì„±ê³µ ì‹œ LoginResponseDtoë¥¼ íŒŒì‹±
                })
                .then(userData => {
                    // ì„±ê³µì ìœ¼ë¡œ ì‚¬ìš©ì ì •ë³´ë¥¼ ë°›ìœ¼ë©´, ë¡œê·¸ì¸ëœ UIë¡œ ë³€ê²½
                    updateUIForLoggedInUser(userData);
                })
                .catch(error => {
                    // ë¡œê·¸ì¸ë˜ì§€ ì•Šì€ ìƒíƒœì´ë¯€ë¡œ ê¸°ë³¸ UI(ë¡œê·¸ì¸/íšŒì›ê°€ì… ë²„íŠ¼) ìœ ì§€
                    console.log('ì„¸ì…˜ í™•ì¸ ê²°ê³¼: ë¡œê·¸ì¸ë˜ì§€ ì•ŠìŒ.', error.message);
                    updateUIForLoggedOutUser();
                });
        }

        // ë¡œê·¸ì¸ëœ ì‚¬ìš©ìë¥¼ ìœ„í•œ UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateUIForLoggedInUser(user) {
            const authButtonsDiv = document.querySelector('.auth-buttons');
            if (!authButtonsDiv) return;

            // ê¸°ì¡´ ë¡œê·¸ì¸/íšŒì›ê°€ì… ë²„íŠ¼ì„ ëª¨ë‘ ì‚­ì œ
            authButtonsDiv.innerHTML = '';

            // í™˜ì˜ ë©”ì‹œì§€ ìƒì„±
            const welcomeMessage = document.createElement('p');
            welcomeMessage.textContent = `${user.nickname}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`;
            welcomeMessage.style.margin = '0';
            welcomeMessage.style.marginRight = '20px';

            // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ìƒì„±
            const logoutButton = document.createElement('button');
            logoutButton.id = 'logoutBtn';
            logoutButton.className = 'modal-trigger-btn'; // ê¸°ì¡´ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì¬ì‚¬ìš©
            logoutButton.textContent = 'ë¡œê·¸ì•„ì›ƒ';
            logoutButton.addEventListener('click', handleLogout);

            // í™”ë©´ì— ì¶”ê°€
            authButtonsDiv.style.display = 'flex';
            authButtonsDiv.style.alignItems = 'center';
            authButtonsDiv.appendChild(welcomeMessage);
            authButtonsDiv.appendChild(logoutButton);

            // íšŒì› íƒˆí‡´ ë²„íŠ¼ ìƒì„±
            const deleteButton = document.createElement('button');
            deleteButton.id = 'deleteBtn';
            deleteButton.textContent = 'íšŒì› íƒˆí‡´';
            deleteButton.style.marginLeft = '10px'; // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ê³¼ ê°„ê²© ë„ìš°ê¸°
            deleteButton.style.backgroundColor = '#dc3545'; // ìœ„í—˜í•œ ì‘ì—…ì´ë¯€ë¡œ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ
            deleteButton.style.color = 'white';
            deleteButton.className = 'modal-trigger-btn';
            deleteButton.addEventListener('click', handleDeleteAccount);

            // í™”ë©´ì— ì¶”ê°€
            authButtonsDiv.appendChild(deleteButton); // íƒˆí‡´ ë²„íŠ¼ ì¶”ê°€
        }

        // ë¡œê·¸ì•„ì›ƒëœ ìƒíƒœë¥¼ ìœ„í•œ UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateUIForLoggedOutUser() {
            const authButtonsDiv = document.querySelector('.auth-buttons');
            if (!authButtonsDiv) return;

            authButtonsDiv.innerHTML = `
            <button id="loginBtn" class="modal-trigger-btn">ë¡œê·¸ì¸</button>
            <button id="registerBtn" class="modal-trigger-btn">íšŒì›ê°€ì…</button>
        `;

            // ë‹¤ì‹œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì—°ê²°í•´ì¤˜ì•¼ í•¨
            document.getElementById('loginBtn').addEventListener('click', () => {
                document.getElementById('loginModal').style.display = 'flex';
            });
            document.getElementById('registerBtn').addEventListener('click', () => {
                document.getElementById('registerModal').style.display = 'flex';
            });
        }

        // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ í•¨ìˆ˜
        function handleLogout() {
            if (!confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            fetch(`${SERVER_BASE_URL}/auth/logout`, { method: 'POST', credentials: 'include' })
                .then(response => {
                    if (response.ok) {
                        alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        window.location.reload(); // í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ UIë¥¼ ì´ˆê¸° ìƒíƒœë¡œ
                    } else {
                        alert('ë¡œê·¸ì•„ì›ƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                })
                .catch(error => {
                    console.error('Logout failed:', error);
                    alert('ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                });
        }

        function handleDeleteAccount() {
            if (!confirm('ì •ë§ë¡œ íšŒì›ì—ì„œ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                return;
            }

            fetch(`${SERVER_BASE_URL}/auth/delete`, {
                method: 'DELETE',
                credentials: 'include'
            })
                .then(response => {
                    if (response.ok) { // 204 No Contentë„ okë¡œ ì²˜ë¦¬ë¨
                        alert('íšŒì› íƒˆí‡´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        window.location.reload();
                    } else {
                        // ì„œë²„ì—ì„œ ë³´ë‚¸ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ë³´ì—¬ì¤„ ìˆ˜ë„ ìˆìŒ
                        alert('íšŒì› íƒˆí‡´ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    }
                })
                .catch(error => {
                    console.error('Delete account failed:', error);
                    alert('íšŒì› íƒˆí‡´ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                });
        }

        // 1. ë°© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        function fetchRooms() {
            fetch(`${SERVER_BASE_URL}/room/list`, { method:'GET' })
            .then(response => {
            if (!response.ok) {
                throw new Error(`ë„¤íŠ¸ì›Œí¬ ì‘ë‹µ ì˜¤ë¥˜: ${response.status} ${response.statusText}`);
            }
            return response.json(); // List<ChatRoomListDto>ì„ ê¸°ëŒ€
            }).then(data => {
		        renderRooms(data); // ë Œë”ë§ í•¨ìˆ˜ì— List<ChatRoomListDto> ì „ë‹¬
	        }).catch(error => {
                console.error('ë°© ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                roomsUl.innerHTML = '<li style="color: red;">ë°© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.</li>';
            });
	    }

		// 2. ë°© ëª©ë¡ ë Œë”ë§
        function renderRooms(roomsList) {
            const roomsUl = document.getElementById('rooms');
            roomsUl.innerHTML = ''; // ê¸°ì¡´ ëª©ë¡ ë¹„ìš°ê¸°

            if (roomsList.length === 0) {
                roomsUl.innerHTML = '<li class="no-rooms">í˜„ì¬ ê°œì„¤ëœ ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
                return;
            }

            roomsList.forEach(room => {
                const li = document.createElement('li');

                // ë¹„ë°€ë°©ì¼ ê²½ìš° ìë¬¼ì‡  ì•„ì´ì½˜ ì¶”ê°€ (FontAwesome ëŒ€ì‹  ì´ëª¨ì§€ ì‚¬ìš©)
                const lockIcon = room.roomType === 'PRIVATE' ? 'ğŸ”’ ' : '';
                // ë°© ì •ë³´ë¥¼ í¬í•¨í•˜ëŠ” HTML ìƒì„±
                // onclick ì´ë²¤íŠ¸ì—ì„œ enterRoom í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ë„ë¡ ìˆ˜ì •
                li.innerHTML = `
            <a href="javascript:void(0);" onclick="enterRoom('${room.id}', '${room.roomType}')">
                ${lockIcon}${room.name}
            </a>
            <span class="room-details">
                (Owner: ${room.ownerName})
            </span>
            <span class="room-count">
                (${room.connCount}/${room.userCount})
            </span>
        `;

                roomsUl.appendChild(li);
            });
        }



    // 3. ìƒˆ ì±„íŒ…ë°© ë§Œë“¤ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        createRoomButton.addEventListener('click', function() {
            document.getElementById('createRoomModal').style.display = 'flex';
        });

        fetchRooms();       // ì´ˆê¸° ë¡œë”© ì‹œ ë°© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        checkLoginStatus(); // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸í•˜ê¸°

        // --- ëª¨ë‹¬ ê´€ë ¨ ë¡œì§ ì¶”ê°€ ---
        (function() {
            // í•„ìš”í•œ DOM ìš”ì†Œë“¤ì„ ëª¨ë‘ ê°€ì ¸ì˜¤ê¸°
            const loginBtn = document.getElementById('loginBtn');
            const registerBtn = document.getElementById('registerBtn');
            const loginModal = document.getElementById('loginModal');
            const createRoomModal = document.getElementById('createRoomModal');
            const registerModal = document.getElementById('registerModal');
            const closeBtns = document.querySelectorAll('.close-btn');

            // ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ ì‹œ ë¡œê·¸ì¸ ëª¨ë‹¬ í‘œì‹œ
            loginBtn.addEventListener('click', () => {
                loginModal.style.display = 'flex'; // CSSì—ì„œ flexë¡œ ì¤‘ì•™ì •ë ¬ í–ˆìœ¼ë¯€ë¡œ flexë¡œ ë³€ê²½
            });

            // íšŒì›ê°€ì… ë²„íŠ¼ í´ë¦­ ì‹œ íšŒì›ê°€ì… ëª¨ë‹¬ í‘œì‹œ
            registerBtn.addEventListener('click', () => {
                registerModal.style.display = 'flex';
            });

            // ë°© íƒ€ì… ë¼ë””ì˜¤ ë²„íŠ¼ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            const roomTypeRadios = document.querySelectorAll('input[name="roomType"]');
            const passwordGroup = document.getElementById('passwordGroup');
            roomTypeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'PRIVATE') {
                        passwordGroup.style.display = 'block';
                    } else {
                        passwordGroup.style.display = 'none';
                    }
                });
            });

            // ëª¨ë“  ë‹«ê¸°(X) ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            closeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // ë²„íŠ¼ì´ ì†í•œ ê°€ì¥ ê°€ê¹Œìš´ .modal-overlayë¥¼ ì°¾ì•„ ìˆ¨ê¹€
                    btn.closest('.modal-overlay').style.display = 'none';
                });
            });

            // ëª¨ë‹¬ì˜ ì–´ë‘ìš´ ë°°ê²½ í´ë¦­ ì‹œ ëª¨ë‹¬ ë‹«ê¸°
            window.addEventListener('click', (event) => {
                if (event.target.classList.contains('modal-overlay')) {
                    event.target.style.display = 'none';
                }
            });

            // --- ì‹¤ì œ ì„œë²„ í†µì‹  ë¡œì§ ---

            // ë¡œê·¸ì¸ í¼ ì œì¶œ ì²˜ë¦¬
            const loginForm = document.getElementById('loginForm');
            loginForm.addEventListener('submit', function(event) {
                event.preventDefault(); // í¼ ê¸°ë³¸ ì œì¶œ ë™ì‘(í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨) ë°©ì§€

                const formData = new FormData(this);
                const data = Object.fromEntries(formData.entries());
                const loginErrorEl = document.getElementById('loginError');
                loginErrorEl.textContent = ''; // ì´ì „ ì—ëŸ¬ ë©”ì‹œì§€ ì´ˆê¸°í™”

                fetch(`${SERVER_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                    credentials: 'include'
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw err; });
                    }
                    return response.json();
                })
                .then(result => {
                    console.log('ë¡œê·¸ì¸ ì„±ê³µ:', result);
                    alert(result.nickname + 'ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!');
                    loginModal.style.display = 'none';
                    // TODO: ë¡œê·¸ì¸ ì„±ê³µ í›„ UI ì—…ë°ì´íŠ¸ (ì˜ˆ: ë²„íŠ¼ ìˆ¨ê¸°ê¸°, ì‚¬ìš©ì ì´ë¦„ í‘œì‹œ)
                    window.location.reload(); // ì„ì‹œë¡œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                })
                .catch(error => {
                    console.error('ë¡œê·¸ì¸ ì‹¤íŒ¨:', error);
                    loginErrorEl.textContent = error.message || 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                });
            });

            // íšŒì›ê°€ì… í¼ ì œì¶œ ì²˜ë¦¬
            const registerForm = document.getElementById('registerForm');
            registerForm.addEventListener('submit', function(event) {
                event.preventDefault(); // í¼ ê¸°ë³¸ ì œì¶œ ë™ì‘ ë°©ì§€

                const formData = new FormData(this);
                const data = Object.fromEntries(formData.entries());
                const registerErrorEl = document.getElementById('registerError');
                registerErrorEl.textContent = ''; // ì´ì „ ì—ëŸ¬ ë©”ì‹œì§€ ì´ˆê¸°í™”

                fetch(`${SERVER_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                    credentials: 'include'
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw err; });
                    }
                    return response.json();
                })
                .then(result => {
                    console.log('íšŒì›ê°€ì… ì„±ê³µ:', result);
                    alert(result.nickname + 'ë‹˜, íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë°”ë¡œ ë¡œê·¸ì¸ë©ë‹ˆë‹¤.');
                    registerModal.style.display = 'none';
                    // TODO: ë¡œê·¸ì¸ ì„±ê³µ í›„ UI ì—…ë°ì´íŠ¸
                    window.location.reload(); // ì„ì‹œë¡œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                })
                .catch(error => {
                    console.error('íšŒì›ê°€ì… ì‹¤íŒ¨:', error);
                    registerErrorEl.textContent = error.message || 'íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                });
            });

            // ìƒˆ ì±„íŒ…ë°© ë§Œë“¤ê¸° í¼ ì œì¶œ ì²˜ë¦¬
            const createRoomForm = document.getElementById('createRoomForm');
            createRoomForm.addEventListener('submit', function(event) {
                event.preventDefault();

                const formData = new FormData(this);
                const data = Object.fromEntries(formData.entries());
                const createRoomErrorEl = document.getElementById('createRoomError');
                createRoomErrorEl.textContent = '';

                // PRIVATE ë°©ì´ ì•„ë‹ˆë©´ password í•„ë“œ ì œê±° (ì„œë²„ DTOì— ë§ì¶¤)
                if (data.roomType !== 'PRIVATE') {
                    delete data.password;
                }

                fetch(`${SERVER_BASE_URL}/room/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                    credentials: 'include'
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw err; });
                    }
                    return response.json();
                })
                .then(roomId => {
                    console.log('ë°© ìƒì„± ì„±ê³µ, ID:', roomId);
                    alert(`'${data.roomName}' ë°©ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    createRoomModal.style.display = 'none';
                    openChatWindow(`chat.html?room=${roomId}`);
                    setTimeout(function(){location.reload();}, 1000);
                })
                .catch(error => {
                    console.error('ë°© ìƒì„± ì‹¤íŒ¨:', error);
                    createRoomErrorEl.textContent = error.message || 'ë°© ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                });
            });

        })();
    });
    // 2-1. ì±„íŒ…ë°© ì…ì¥ ì²˜ë¦¬ í•¨ìˆ˜
    function enterRoom(roomId, roomType) {
        let password = null;
        // ë¹„ë°€ë°©ì˜ ê²½ìš° ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥ë°›ìŒ
        if (roomType === 'PRIVATE') {
            // ì„œë²„ì— ì…ì¥ ìš”ì²­
            fetch(`${SERVER_BASE_URL}/room/`+roomId+`/users`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({password:password}),
                credentials: 'include' // ì„¸ì…˜ ìœ ì§€ë¥¼ ìœ„í•´ ì¿ í‚¤ í¬í•¨
            })
            .then(response => {
                if (response.ok) {
                    // ì…ì¥ì´ ì„±ê³µí•˜ë©´ ì±„íŒ…ì°½ì„ ì—°ë‹¤.
                    openChatWindow(`chat.html?room=${roomId}`);
                } else {
                    // ì„œë²„ì—ì„œ ë³´ë‚¸ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ë°›ì•„ì„œ throw
                    return response.json().then(err => { throw err; });
                }
            })
            .catch(error => {
                password = prompt("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
                if (password === null) { // ì‚¬ìš©ìê°€ 'ì·¨ì†Œ'ë¥¼ ëˆ„ë¥¸ ê²½ìš°
                    return;
                }

                const enterRequest = {
                    password: password
                };

                // ì„œë²„ì— ì…ì¥ ìš”ì²­
                fetch(`${SERVER_BASE_URL}/room/`+roomId+`/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(enterRequest),
                    credentials: 'include' // ì„¸ì…˜ ìœ ì§€ë¥¼ ìœ„í•´ ì¿ í‚¤ í¬í•¨
                })
                    .then(response => {
                        if (response.ok) {
                            // ì…ì¥ì´ ì„±ê³µí•˜ë©´ ì±„íŒ…ì°½ì„ ì—°ë‹¤.
                            openChatWindow(`chat.html?room=${roomId}`);
                        } else {
                            // ì„œë²„ì—ì„œ ë³´ë‚¸ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ë°›ì•„ì„œ throw
                            return response.json().then(err => { throw err; });
                        }
                    })
                    .catch(error => {
                        console.error('ì±„íŒ…ë°© ì…ì¥ ì‹¤íŒ¨:', error);
                        // error.messageëŠ” ì„œë²„ì˜ ErrorResponseDtoì— ë‹´ê¸´ message í•„ë“œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        alert(error.message || 'ì±„íŒ…ë°© ì…ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    });
            });


        }


    }

	function openChatWindow(url) {
		const chatPageURL = 'chat.html';
		const windowName = 'chatWindow';
		// ì›í•˜ëŠ” ì°½ ì†ì„±ë“¤ì„ ì—¬ê¸°ì— ì„¤ì •
		const windowFeatures = 'width=700,height=750,scrollbars=no,status=no,menubar=no,toolbar=no,location=no';
		const chatWindow = window.open(url, windowName, windowFeatures);

		if (chatWindow) {
			chatWindow.focus();
		} else {
			alert('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ íŒì—…ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
		}
	}

</script>
</body>
</html>