<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Simple Chat</title>
</head>
<style>
  li {
    margin-bottom: 8px;
    padding: 5px;
    border: 1px solid #eee;
  }
  #box {
    margin-top: 5px;
    height: 20px;
    font: 16px Consolas bold;
  }

  #button {
    padding-top: 5px;
  }
</style>
</html>
<body>
<input type="text" size=50 id="box" name="box" placeholder="메시지 입력"></input>
<button id="button" onclick=send()>보내기</button>
<p id="output">여기에 응답 표시</p>
<ul id="chat-log" style="border: 1px solid #ccc; padding: 10px; list-style: none;">
</ul>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.js"></script>
<script>
  // 기존 스크립트 시작 부분에 변수 선언 추가
  var stompClient = null;
  var username = "client"; // 사용자 이름을 고정하거나 입력받도록 조정

  // ... 기존 p, chatLogElement, box, button 변수들 ...
  const messageInput = document.getElementById('box'); // 기존 id "box" 사용
  const sendButton = document.getElementById('button'); // 기존 id "button" 사용
  const chatLogElement = document.getElementById('chat-log'); // 기존 id "chat-log" 사용


  // --- WebSocket/STOMP 관련 함수 추가 시작 ---

  // 웹소켓 연결 시작 (페이지 로드 또는 특정 버튼 클릭 시 호출)
  function connect() {
    // 이 예제에서는 사용자 이름을 "client"로 고정했지만, 실제로는 입력받아 사용
    // username = document.getElementById('usernameInput').value.trim(); // 사용자 입력 시 활성화

    console.log("WebSocket 연결 시도...");
    var socket = new SockJS('http://localhost:8080/ws');
    stompClient = Stomp.over(socket);

    // STOMP 클라이언트 연결
    // 연결 성공 시 onConnected 호출, 실패 시 onError 호출
    stompClient.connect({}, onConnected, onError);
  }

  // STOMP 연결 성공 시 호출되는 콜백 함수
  function onConnected() {
    console.log("WebSocket 연결 성공!");
    document.getElementById("output").textContent = "서버 응답: WebSocket 연결됨"; // 상태 표시 업데이트

    // 1. 공용 채팅 토픽 구독: 서버가 /topic/public으로 보내는 모든 새 메시지를 수신
    stompClient.subscribe('/topic/public', onMessageReceived);

    // (선택 사항) 서버에 사용자 등록 메시지 전송 (세션에 사용자 이름 저장용)
    // 백엔드 ChatStompController의 @MessageMapping("/chat.addUser")를 사용한다면
    // stompClient.send("/app/chat.addUser", {}, JSON.stringify({ sender: username }));

    // 초기 채팅 내역은 기존 getChat() 함수 (fetch)를 통해 가져옵니다.
    getChat("http://localhost:8080/init");
  }

  // STOMP 연결 실패 시 호출되는 콜백 함수
  function onError(error) {
    console.error("WebSocket 연결 실패:", error);
    document.getElementById("output").textContent = "서버 응답: WebSocket 연결 실패. " + error;
  }

  // 웹소켓을 통해 새 메시지를 받았을 때 호출되는 함수
  function onMessageReceived(payload) {
    const message = JSON.parse(payload.body);
    console.log("웹소켓으로 새 메시지 수신:", message);
    displayMessage(message); // 받은 메시지를 화면에 표시
  }

  // 화면에 메시지를 표시하는 범용 함수
  // 기존 getChat의 forEach 루프와 onMessageReceived에서 모두 사용하도록 함수 분리
  function displayMessage(message) {
    const listItem = document.createElement('li'); // 새로운 <li> 요소 생성
    const formattedChat = message.chat.replace(/\n/g, '<br>');

    // 메시지 형식 (sender가 있는 경우)
    if (message.sender) {
      listItem.innerHTML = `<strong>${message.sender}:</strong> ${formattedChat}`;
    } else { // sender 정보가 없는 경우 (기존 코드의 `id`가 sender 역할이었을 수 있음)
      listItem.innerHTML = `<strong>${message.id || '알 수 없음'}:</strong> ${formattedChat}`;
    }

    chatLogElement.appendChild(listItem); // ul에 li 추가
    chatLogElement.scrollTop = chatLogElement.scrollHeight; // 스크롤을 항상 최하단으로 내립니다.
  }
  // --- WebSocket/STOMP 관련 함수 추가 끝 ---


  // --- 기존 getChat 함수 수정 ---
  // 이제 이 함수는 초기 메시지 로딩 시 한 번만 호출됩니다.
  // 기존의 `p.textContent = "서버 응답: " + data;` 부분은 웹소켓 연결 상태를 표시하는 것으로 대체될 수 있습니다.
  function getChat(url="http://localhost:8080/init"){ // URL을 /init으로 고정
    fetch(url)
            .then(response => response.json()) // JSON 응답을 기대
            .then(data => {
              // p.textContent = "서버 응답: " + data.length + "개 초기 메시지"; // 상태창은 웹소켓이 관리
              // 기존 메시지들 비우고 다시 로드 (선택 사항: 아니면 새로고침 없이 계속 쌓이도록)
              chatLogElement.innerHTML = '';
              data.forEach(message => {
                displayMessage(message); // 받은 메시지를 화면에 표시
              });
            })
            .catch(error => console.error('Error fetching initial chat history:', error));
  }


  // --- 기존 send 함수는 그대로 유지 (HTTP POST로 메시지 전송) ---
  function send(){
    const response = fetch('http://localhost:8080/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: new URLSearchParams({
        message: document.getElementById('box').value // "message"는 서버 컨트롤러의 @RequestParam 이름과 일치
      })
    });

    document.getElementById("box").value = "";
  }

  // --- 이벤트 리스너 및 초기 호출 ---
  document.getElementById('box').addEventListener('keydown', (event) => {
    if (event.key === 'Enter')
      send();
  });

  // 페이지 로드 시 웹소켓 연결 시작
  document.addEventListener('DOMContentLoaded', connect); // 이제 페이지 로드 시 바로 연결 시작
  // setInterval(getChat, 1000); // 숏폴링은 이제 사용하지 않음
</script>